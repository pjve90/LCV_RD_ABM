---
title: "Untitled"
author: "Pablo J. Varas Enr√≠quez"
date: "19-05-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("RColorBrewer")
library(RColorBrewer)
```

## First attempt: one life cycle stage, two resource dynamics.

An agent-based model is developed here with a population of 1000 individuals that have only one life cycle stage (i.e. reproductive career) and experience two resource dynamics (i.e. production and consumption). All individuals start with the maximum amount of resources that can be produced in one iteration (1) to ensure they can survive at initialization.

### Auxiliary variables

The auxiliary variables are fixed values set at initialization that define the life-history and resource dynamics that individuals can experience. Regarding life-history dynamics, you define:

-   Survival cost (`surv_c`).
-   Age-specific survival cost (`surv_c_age`).
-   Cost of reproduction (`repro_c`).
-   Age-specific cost of reproduction (`repro_c_age`).

Regarding resource dynamics, the auxiliary variables are:

-   Probability of production (`prod_p`).
-   Amount of resources produced (`prod_n`).
-   Amount of resources consumed (`cons_n`).

#### Survival and reproductive costs.

We assume that the cost of survival grows exponentially through time considering the effect of senescence. We also assume that individuals can produce one unit of resources and consume 0.25 units of resources per year. We also assume that the longest lifespan an individual can have is 100 years, and that the cost of survival at birth is 0.25. Therefore, the maximum amount of resources an individual can have through her life cycle, without survival and reproductive costs, can be calculated as follows:

$$
\text{Lifetime resources available}=(\text{Production}-\text{Consumption})*\text{Longevity}
\\
\text{Lifetime resources available}=(1-0.25)*100
\\
\text{Lifetime resources available}=75
$$
Following the assumption that the cost of survival grows exponential growth through time, we can calculate the rate of growth as follows:

$$
x_t=x_0e^{rt}
\\
75=0.25e^{r100}
\\
0.057=r
$$
Hence, the age-specific survival cost can be calculate with the formula for exponential growth and the values that we have so far:

$$
x_t=x_oe^{rt}
\\
x_t=0.25e^{0.057t}
$$
Based on the formula, the curve of age-specific survival costs would be:

```{r}
surv_c_age <- c(0.25,c(0.25*exp(0.057*c(1:100))))
```

We asume that the costs of reproduction also grow exponentially in order to account for reproductive senescence. We use the same formula as before but we asume the cost of reproduction is higher than for survival (`repro_c`=2). The formula would be:

$$
x_t=x_oe^{rt}
\\
x_t=2e^{0.057t}
$$

Based on the formula, the curve of age-specific reproductive costs would be:

```{r}
repro_c_age <- c(1,c(1*exp(0.057*c(1:100))))
```

#### Resource dynamics

Individuals can produce one unit of resources, with a probability of 0.9. Consumption is constant through time with a value of 0.25.

```{r}
#production probability
prod_p <- 0.9
#amount of resources produced
prod_n <- 1

#consumption
cons_n <- 0.25
```

The remaining resources at the end of the iteration are carried to the next iteration (`prod_a`).

### State variables

#### Survival and reproduction

The state variables are the ones that change from one iteration to the next one. Regarding life-history dynamics, you define:

- Die: function that defines if an individual dies (1) or not (0), based on having the resources to cover the age-specific survival costs (`die`).
- Age: function that records the number of times an individual survives through the years (`age`).
- Discount of survival cost: function that estimates the amount of resources available after discounting the costs of age-specific survival costs (`survive_c`).

```{r}
#die
die <- function(it_indpop){
  if(it_indpop$prod_a[i] < surv_c_age[it_indpop$age[i]+1]){
    it_indpop$surv[i] <- 0
  } else{
  it_indpop$surv[i] <- 1
  }
return(it_indpop$surv)
}

#age
age <- function(it_indpop){
  it_indpop$age[i] <- it_indpop$age[i]+it_indpop$surv[i]
  return(it_indpop$age)
}

#discount survival costs
survive_c <- function(it_indpop) {
    it_indpop$prod_a[i] <- it_indpop$prod_a[i]-surv_c_age[it_indpop$age[i]+1]*it_indpop$surv[i]
    return(it_indpop$prod_a)
}
```

- Reproduction: function that defines if an individual reproduces (1) or not (0), based on having the resources to cover the age-specific reproductive costs (`reproduce``).
- Discount of reproductive cost: function that estimates the amount of resources available after discounting the costs of age-specific reproductive costs (`reproduce_c`).
- Add newborn: function that adds newborns in the population at the end of the iteration

```{r}
#reproduction
reproduce <- function(it_indpop){
  if(it_indpop$prod_a[i] < repro_c_age[it_indpop$age[i]+1]){
    it_indpop$repro[i] <- 0
  } else{
  it_indpop$repro[i] <- 1
  }
  return(it_indpop$repro)
}

#discount reproductive costs
reproduce_c <- function(it_indpop) {
    it_indpop$prod_a[i] <- it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]*it_indpop$repro[i]
    return(it_indpop$prod_a)
}

#add newborn
newborn <- function(it_indpop){
  if(sum(it_indpop$repro)==0){
    it_indpop <- it_indpop
  } else{
    #create pop of newborns
    new_it_indpop <- data.frame(id=max_id+1:sum(it_indpop[which(it_indpop$repro==1),"repro"]),surv=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),age=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_o=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_a=rep(1,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),cons=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),repro=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])))
    #combine original population with newborns
    it_indpop <- rbind(it_indpop,new_it_indpop)
  }
  return(it_indpop)
}
```

#### Resource dynamics

An individual produces resources based on a random sampling from a binomial distribution with the probability of production (`prod_p`). She will add one unit of resources (`prod_n`) to the resources available (`prod_a`) if the individual samples a positive outcome (1). Consumption is a fixed value through time.

```{r}
#production
produce <- function(it_indpop){
  it_indpop$prod_o[i] <- rbinom(1,1,prod_p)
  return(it_indpop$prod_o)
}

#adding resources produced
produce_a <- function(it_indpop) {
  it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n
  return(it_indpop$prod_a)
}

#consumption
consume <- function(it_indpop) {
  it_indpop$cons[i] <- cons_n
  it_indpop$prod_a[i] <- it_indpop$prod_a[i]-it_indpop$cons[i]
  return(it_indpop)
}
```

### Building the simulation

#### One year

Now, we use the functions in a population of 1000 individuals where all are in their reproductive career stage (`it_indpop`). They start with one unit of resources. We also use create a database to record the dynamics through time (`it_data`). Other datasets are used to feed `it_data`, which are based on the survival outcome (`surv_data`), resource production (`resource_data`), and reproduction (`repro_data`).

```{r}
#create population
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(0,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(1,length.out=1000),cons=rep(NA,length.out=1000),repro=rep(NA,length.out=1000))
#create iteration record
it_data <- data.frame(id=1:1000)

#run one iteration for all the population
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- die(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#remove individuals that died
it_indpop <- it_indpop[!(it_indpop$surv==0),]
#calculate age, survival cost, production, consumption, and reproductive outcome
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$prod_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
  #consumption
  it_indpop <- consume(it_indpop)
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$prod_a <- reproduce_c(it_indpop)
}
#record production outcome, resources available, and consumption
resource_data <- it_indpop[,c("id","prod_o","prod_a", "cons")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#add newborns
it_indpop <- newborn(it_indpop)
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data),full_join,by="id",suffix=c("0","1"))
```

#### 100 years

Now that the model works for one iteration, we can make it run for more years. We are running it for 100 years.

```{r}
#create population
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(0,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(1,length.out=1000),cons=rep(NA,length.out=1000),repro=rep(NA,length.out=1000))
#create iteration record
it_data <- data.frame(id=1:1000)

#run 100 iterations
for (b in 1:100){
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- die(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#remove individuals that died
it_indpop <- it_indpop[!(it_indpop$surv==0),]
#calculate age, survival cost, production, consumption, and reproductive outcome
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$prod_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
  #consumption
  it_indpop <- consume(it_indpop)
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$prod_a <- reproduce_c(it_indpop)
}
#record production outcome, resources available, and consumption
resource_data <- it_indpop[,c("id","prod_o","prod_a", "cons")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#add newborns
it_indpop <- newborn(it_indpop)
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data),full_join,by="id",suffix=as.character(c(b-1,b)))
}
```

### Exploring the output of the simulation

Now that there is a record for the survival, reproduction, and resource dynamics of each individual every year, it is possible to create the functions to calculate the different life-history traits and resource-dynamics of interest for each individual:

-   Longevity: number of years from birth to death.
-   Lifetime reproductive output (LRO): total number of descendants.
-   Age at first reproduction (AFR): age at which the individual has her first descendant.
-   Age at last reproduction (ALR): age at which the individual has her last descendant.

```{r}
#longevity
longevity <- function(final_ind_data){
  final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T)) + 11
  return(final_ind_data$lng)
}

#LRO
lro <- function(final_ind_data){
  final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) 
  return(final_ind_data$lro)
}

#AFR
afr <- function(final_ind_data){
  if(final_ind_data$lro[i] == 0){
    final_ind_data$afr[i] <- NA 
  }else{
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$afr)
}

#ALR
alr <- function(final_ind_data){
 if(final_ind_data$lro[i] == 0){
    final_ind_data$alr[i] <- NA 
  }else{
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$alr)
}
```

The functions for the lifetime resource dynamics of each individual are developed below. The dynamics that would be calculated are:

-   Lifetime production events: total number of positive outcomes (1) from the production function during the lifetime of an individual.
-   Lifetime consumption events: total number of consumption events during the lifetime of an individual. This amount should be the same as the age of an individual since consumption is fixed.
-   Lifetime resource production: total amount of resources produced during the lifetime of an individual.
-   Lifetime resource consumption: total amount of resources consumed during the lifetime of an individual.
-   Lifetime resources available: total amount of resources available during the lifetime of an individual.
-   Average resources available: average amount of resources available during the lifetime of an individual.
-   Variability resources available: variance of the amount of resources available during the lifetime of an individual.

```{r}
#production events
production_ev <- function(final_ind_data){
  final_ind_data$prod_ev[i] <- as.numeric(rowSums(it_data[i,grep("prod_o",colnames(it_data))],na.rm = T))
  return(final_ind_data$prod_ev)
}

#consumption events
consumption_ev <- function(final_ind_data){
  final_ind_data$cons_ev[i] <- final_ind_data$lng[i]
  return(final_ind_data$cons_ev)
}

#resource production
production_res <- function(final_ind_data){
  final_ind_data$prod_res[i] <- final_ind_data$prod_ev[i]*prod_n 
  return(final_ind_data$prod_res)
}

#resource consumption
consumption_res <- function(final_ind_data){
  final_ind_data$cons_res[i] <- final_ind_data$cons_ev[i]*cons_n
  return(final_ind_data$cons_res)
}

#resources available
available_res <- function(final_ind_data){
  final_ind_data$avai_res[i] <- as.numeric(rowSums(it_data[i,grep("prod_a",colnames(it_data))],na.rm=T))
  return(final_ind_data$avai_res)
}
  
#average resources available
available_av <- function(final_ind_data){
  final_ind_data$avai_av[i] <- mean(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_av)
}

#variance resources available
available_var <- function(final_ind_data){
  final_ind_data$avai_var[i] <- var(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_var)
  }
```

Once the functions to calculate the life-history traits and resource dynamics for each individual, it is possible to use them in the individuals from the population that was simulated for 100 years (`it_data`). The calculations for each individual are recorded in a separate database (`final_ind_data`).

```{r}
#create dataset
final_ind_data <- data.frame(id=1:nrow(it_data))

for(i in 1:nrow(it_data)){
  #life-history traits
  #longevity
final_ind_data$lng <- longevity(final_ind_data)
  #lro
final_ind_data$lro <- lro(final_ind_data)
  #afr
final_ind_data$afr <- afr(final_ind_data)
  #alr
final_ind_data$alr <- alr(final_ind_data)
  #resource dynamics
  #production events
final_ind_data$prod_ev <- production_ev(final_ind_data)
  #consumption events
final_ind_data$cons_ev <- consumption_ev(final_ind_data)
  #resource production
final_ind_data$prod_res <- production_res(final_ind_data)
  #resource consumption
final_ind_data$cons_res <- consumption_res(final_ind_data)
  #resources available
final_ind_data$avai_res <- available_res(final_ind_data)
  #average resources available
final_ind_data$avai_av <- available_av(final_ind_data)
  #variance resources available
final_ind_data$avai_var <- available_var(final_ind_data)
}

#plot it
#plot distributions of life-history traits
par(mfrow=c(2,2))
hist(final_ind_data$lng)
hist(final_ind_data$lro)
hist(final_ind_data$afr)
hist(final_ind_data$alr)
#plot distributions of resource dynamics
layout(matrix(c(1,1,2,2,3,3,4,4,0,5,5,6,6,7,7,0),nrow=2,byrow=TRUE))
hist(final_ind_data$prod_ev)
hist(final_ind_data$cons_ev)
hist(final_ind_data$prod_res)
hist(final_ind_data$cons_res)
hist(final_ind_data$avai_res)
hist(final_ind_data$avai_av)
hist(final_ind_data$avai_var)
#pairwise relationship 
pairs(~lng+lro+afr+alr+prod_ev+cons_ev+prod_res+cons_res+avai_res+avai_av+avai_var,data=final_ind_data)
#pairwise relationship of life-history traits with resource availability measurements
pairs(~lng+lro+afr+alr+avai_res+avai_av+avai_var,data=final_ind_data)
```


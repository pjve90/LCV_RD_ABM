---
title: 'Life cycle variation and resource dynamics ABM: Code'
author: "Pablo J. Varas Enr√≠quez"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_TIME", "C")
```

## Outline

The following code is meant to develop an agent-based model to understand how the resource dynamics of female individuals influence the variability of life cycles at the population level. For this, the following variables are needed in the model, at the individual and population levels:

| Level | Life cycle | Resource dynamic |
| --- | --- | --- |
| Individual | Longevity |  Lifetime production variability |
|  | Lifetime reproductive output | Lifetime resource production |
|  | Age at # reproduction | Lifetime consumption variability |
|  | Average interbirth interval |  Lifetime resource consumption |
|  | Age at life cycle stage transition |  Lifetime storage variability |
|  |  | Lifetime resource storage |
|  |  | Lifetime giving variability |
|  |  | Lifetime resource given |
|  |  | Lifetime recieving variability |
|  |  | Lifetime resource recieved |
| Population | Longevity variability | |
|  | Lifetime reproductive output variability | |
|  | Age at # reproduction variability | |
|  | Average interbirth interval variability | |
|  | Age at life cycle stage transition variability | |

At first, there is a section called "Starting point", which are the first attempts and checks of the model. Different modules are used to build the initial states of the model, with less life cycle stages and resource dynamics. Once less modules work, more modules will be developed and included in the model. The starting point has two life cycle stages (i.e. juvenile, reproductive career), and two resource dynamics (i.e. production, consumption).

The following sections are the different scenarios where the model will be used. The scenarios are:

- A population where all individuals have medium probabilities of resource production and sharing.
- A population where all individuals have high probabilities for resource production and sharing.
- A population where most individuals (75% of the population) have a high probability of production and low probability of sharing. The rest (25%) have medium probabilities for production and sharing.
- A population where most individuals (75% of the population) have a low probability of production and high probability of sharing. The rest (25%) have medium probabilities for production and sharing.
- A population where all individuals have low probabilities for resource production and sharing.

### Starting point

The starting point section consists of the different attempts to start building the model. First, there will be one life cycle stage and the resource dynamics of production and consumption. Second, one with two life cycle stages, production, and consumption. Third, storage will be added, and finally, one with sharing dynamics.

#### First attempt: one life cycle stage, two resource dynamics.

An agent-based model is developed here with a population of 1000 indvidiuals that have only one life cycle stage and experience two resource dynamics (i.e. production and consumption).

First, a database is set to record the variability of life cycles at the population level. The following variables are used to characterize the life cycle variability:

- `lng_var`: Longevity variance
- `lro_var`: Lifetime reproductive output variance
- `age_repro_i_var`: Age at the $i$th reproduction variance. A new variable is made for the age of each reproductiv event.
- `ibi_var`: Average interbirth interval variance.

Second, a database is set to record the final outcome of life cycles and resource dynamics of each of the 1000 individual in the population. This database is used to calculate the variability of life cycles at the population level. The variables used are:

- `ID`: identity of the individual.
- `age`: number of years the individuals lives.
- `prod_n`: total number of successful outcomes in resource production by the individual in her life cycle.
- `prod`: total amount of resources produced by the individual in her life cycle.
- `cons`: total amount of resources consumed by the individual in her life cycle.
- `lro`: lifetime reproductive output.
- `age_repro:i`: age at which the individual has her $i$th descendant. There should be a new one for each reproductive event.
- `ibi`: average interbirth interval.

Third, a database is set to record the individual dynamics in the population in one iteration (i.e. one year). This database is used to record the development of the different individuals across their life cycle, by recording the changes from one year to another, and estimate the final outcomes of each individual. The variables used are:

- `ID`: identity of the individual.
- `surv`: outcome from the survival function. The individual can survive (1) or not (0).
- `age`: number of years the individual has.
- `prod_o`: outcome from the resource production function. The individual can produce (1) or not (0).
- `prod_a`: amount of resources produced by the individual in the iteration.
- `cons`: amount of resources consumed by the individual in the iteration.
- `repro`: outcome from the reproduction function. The individual can reproduce (1) or not (0).

```{r}
#life cycle variability database
lcv_pop <- data.frame(lng_var=NA,lro_var=NA,age_repro_i_var=NA,ibi_var=NA)
#check data frame
head(lcv_pop)

#individual final outcome database
final_indpop <- data.frame(id=1:1000,age=rep(NA,length.out=1000),prod_n=rep(NA,length.out=1000),prod=rep(NA,length.out=1000),cons=rep(NA,length.out=1000),lro=rep(NA,length.out=1000),age_repro_i=rep(NA,length.out=1000),ibi=rep(NA,length.out=1000))
#check data frame
head(final_indpop)

#individual iteration database
it_indpop <- data.frame(id=1000,surv=rep(NA,length.out=1000),age=rep(NA,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(NA,length.out=1000),cons=rep(NA,length.out=1000),repro=rep(NA,length.out=1000))
```

You set the auxiliary variables, which are fixed values set at initialisation to define the life-history and resource dynamics that individuals can experience. Regarding life-history dynamics, you define the surviving probability (`surv_p`) and cost (`surv_c`), the reproductive probability (`repro_p`), cost (`repro_c`), and number of descendants per reproduction (`repro_n`). Resource-related auxiliary variables are the probability of production (`prod_p`), the amount that can be produced (`prod_n`), and the amount of resources that are consumed (`cons_n`). An individual can only produce one descendant in case of a reproductive event.

```{r}
####values are made up for now

#surival
#probability of surviving
surv_p <- 0.75
#cost of surviving
surv_c <- 0.25

#reproduction
#probability
repro_p <- 0.5
#cost of reproduction
repro_c <- 0.25
#number of descendants per reproduction
repro_n <- 1

#production
#probability
prod_p <- 0.5
#amount of resources produced
prod_n <- 1

#consumption
#amount of resources consumed
cons_n <- 0.25
```








You set the functions for the state variables related to resource dynamics (i.e. production and consumption). The outcomes of the functions can be positive (1) or negative (0) from binomial distributions that are based on the values of the auxiliary variables.

```{r}
#production
produce <- function(ind){
  ind$prod <- sample(x=rbinom(1,1,prod_p),size=nrow(ind),prob=prod_p)
  return(ind)
}

####Comment from Dieter: The function above seems to be set up wrong. It looks like you are adding an extra step with sampling, which is not necessary because the repetition can already be included in th rbinom function. With the combination, you get an error because you cannot sample repeatedly if there is only a single outcome (the other way around could work). I think it can simply be:
# produce <- function(ind){
#  ind$prod<-rbinom(nrow(ind),1,prod_p)
#  return(ind)
# }


# Same goes for this consumption function:

#consumption
consume <- function(ind){
  ind$cons <- sample(x=rbinom(1,1,cons_p),size=nrow(ind),prob=cons_p)
  return(ind)
}

# consume <- function(ind){
#  ind$cons<-rbinom(nrow(ind),1,cons_p)
#  return(ind)
# }



# For both though, i wonder whether you need to plan the functions more flexibly. If I understand it correctly, the production probability can change according to the stage the individual is in. So I think that this should be part of the function definition:

# produce <- function(ind,production_probability){
#  ind$prod<-rbinom(nrow(ind),1,production_probability)
#  return(ind)
# }

# The function can than be used as:
# produce(pop,prod_p)
# Where the prod_p can be adjusted according to the stage of the individuals. Though I assume if you end up having a population where individuals are in different stages, you presumably want to make this a two-step process:

# produce <- function(ind){
#  ind$proc_b<-ifelse(ind$age<6,proc_b_infant,ifelse(ind$age<15,proc_b_juvenile,0))  # I think there is some way to set this up better
#  ind$prod<-rbinom(nrow(ind),1,ind$proc_b)
#  return(ind)
# }


```

You set the functions to define the amount of resources the individuals has for herself. If the individual has a positive outcome (1) for a resource dynamic it adds the fixed amount of resource set up earlier into her current amount of resources. Otherwise (0), the amount of resources remains equal.

```{r}
#getting resources from production



#### Comment from Dieter: I think there are similar issues here with your attempt at repeating an action across multiple entries in the same dataframe. I think people like Richard and others use 'apply' functions for this. I tend to use loops because it helps me to keep track. Here though, I think even that is not needed, because the previous outcome of the probability of production is either 0 or 1. So I think this can simply be:

# prod_res <- function(ind){
#   
#     ind$res_prod <- ind$res_prod+ind$prod*prod_n
#   
#   return(ind)
# }





prod_res <- function(ind){
  if(ind$prod==1)
  {
    ind$res_prod <- ind$res_prod+prod_n
  }
  else{
    ind$res_prod <- ind$res_prod
  }
  return(ind)
}

#losing resources from consumption
cons_res <- function(ind){
  if(ind$cons==1)
  {
    ind$res_cons <- ind$res_cons+cons_n
  }
  else{
    ind$res_cons <- ind$res_cons
  }
  return(id)
}
```

You set the functions for survival and reproduction (i.e. state variables). The probabilities of each function include the probability of survival/reproduction and the resources available from the different dynamics. A positive outcome is a 1 and a negative one is 0.

```{r}
#survival
survive <- function(ind){
  ind$surv <- sample(x=rbinom(1,1,surv),size=nrow(ind),prob=surv*ind$res_prod*ind$res_cons)
  return(ind)
}

#reproduction
reproduce <- function(ind){
  ind$repro <- sample(x=rbinom(1,1,repro),size=nrow(ind),prob=repro*ind$res_prod*ind$res_cons)
  return(ind)
}
```

You set the functions to include the resource costs related to survival and reproduction. If the individual has a positive outcome (1) for either life-history trait then the fixed amount of resources are substracted from the amount of resources available. If the outcome is negative (0) then either the individual dies, in the case of survival, or does not produce a descendant, in the case of reproduction.


```{r}
#survival-resource dynamics
surv_res <- function(ind){
  if(ind$surv==1)
  {
    ind$res_prod <- ind$res_prod-surv_c
  }
  else{
    ind$res_prod <- ind$res_prod
  }
  return(ind)
}

#reproduction-resource dynamics
repro_res <- function(ind){
  if(ind$repro==1)
  {
    ind$res_prod <- ind$res_prod-repro_c
    ind$repro_n <- repro_n+1
  }
  else{
    ind$res_prod <- ind$res_prod
    ind$repro_n <- repro_n
  }
  return(id)
}
```





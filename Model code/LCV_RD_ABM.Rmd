---
title: 'Life cycle variation and resource dynamics ABM: Code'
author: "Pablo J. Varas Enr√≠quez"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale("LC_TIME", "C")
#install.packages("tidyverse")
library(tidyverse)
#install.packages("RColorBrewer")
library(RColorBrewer)
#install.packages("summarytools")
#library(summarytools)
```

## Outline

The following code is meant to develop an agent-based model to understand how the resource dynamics of female individuals influence the variability of life cycles at the population level. For this, the following variables are needed in the model, at the individual and population levels:

| Level      | Life cycle                                     | Resource dynamic              |
|------------|------------------------------------------------|-------------------------------|
| Individual | Longevity                                      | Lifetime production events    |
|            | Lifetime reproductive output                   | Lifetime receiving events     |
|            | Age at first reproduction                      | Lifetime consumption events   |
|            | Age at last reproduction                       | Lifetime giving events        |
|            | Age at life cycle stage transition             | Lifetime storage events       |
|            |                                                | Lifetime resources produced   |
|            |                                                | Lifetime resources received   |
|            |                                                | Lifetime resources consumed   |
|            |                                                | Lifetime resources gave       |
|            |                                                | Lifetime resources stored     |
| Population | Longevity variability                          | Average resources produced    |
|            | Lifetime reproductive output variability       | Average resources received    |
|            | Age at first reproduction variability          | Average resources consumed    |
|            | Age at last reproduction variability           | Average resources gave        |
|            | Age at life cycle stage transition variability | Average resources stored      |
|            |                                                | Variability resources produced|
|            |                                                | Variability resources received|
|            |                                                | Variability resources consumed|
|            |                                                | Variability resources gave    |
|            |                                                | Variability resources stored  |

At first, there is a section called "Starting point", which are the exploration of the data used to inform the parameters, as well as the first attempts and checks of the model. Different modules are used to build the initial states of the model, with less life cycle stages and resource dynamics. Once few modules work, more modules will be developed and included in the model. The starting point has one life cycle, and two resource dynamics (i.e. production, consumption), and builds-up from there. Here, the values used are partly based on age-specific survival and fertility estimates from Davison and Gurven (2021), and partly based on not necessarily realistic since they are intended to help building the different modules.

The following sections are the different scenarios where the model will be used. The values used in these scenarios are based on cross-cultural research. The scenarios are:

1.  A population where all individuals have medium probabilities of resource production and sharing.
2.  A population where all individuals have high probabilities for resource production and sharing.
3.  A population where most individuals (75% of the population) have a high probability of production and low probability of sharing. The rest (25%) have medium probabilities for production and sharing.
4.  A population where most individuals (75% of the population) have a low probability of production and high probability of sharing. The rest (25%) have medium probabilities for production and sharing.
5.  A population where all individuals have low probabilities for resource production and sharing.

### Starting point

The starting point section consists of the development of the different modules that will be used to build the final model. First, there is a section to explore and check the data that is going to be used to inform the auxiliary and state variables. Second, the development of the module for individuals in their reproductive career stage and the resource dynamics of production and consumption (i.e. one life cycle stage, two resource dynamics). Third, a model with two life cycle stages (i.e. infant, reproductive career), production, consumption, and storage. Fourth, adult and post-reproductive stages will be added. Accordingly, the final model will have individuals going through four life stages (infant, adult, reproductive, post-reproductive) and in each experiencing four different resource dynamics (production, consumption, sharing, storage).

#### Data exploration and check up

The age-specific survival and fertility estimates from Davison and Gurven, 2021 are used to inform the parameters related to survival probabilities and reproduction across the life cycle of individuals. Here, are some explorations of the differences among the populations.

```{r}
#survival estimates
#import data
surv_est <- read.csv("https://raw.githubusercontent.com/pjve90/LCV_RD_ABM/main/Model%20code/S2_Table_Age_Specific_Survival.csv?token=GHSAT0AAAAAABWW7XYAA6FSMXU7OHKWOD6MYW6LNIQ", header = TRUE, sep = ",", stringsAsFactors = FALSE)
#select human populations
surv_est <- surv_est[,c("Age","Ache","Agta","Hadza","Hiwi","X.Kung","Aborigine","Gainj","Tsimane","Yanomamo","Herero")]

#fertility estimates
fert_est <- read.csv("https://raw.githubusercontent.com/pjve90/LCV_RD_ABM/main/Model%20code/S3_Table_Age_Specific_Fertility.csv?token=GHSAT0AAAAAABWW7XYB3TGDRGR5PYPO6MKGYW6LNKA",header = T)
#select human populations
fert_est <- fert_est[,c("Age","Ache","Agta","Hadza","Hiwi","X.Kung","Aborigine","Gainj","Tsimane","Yanomamo","Herero")]

#summary of estimates
#survival
summary(surv_est[,2:11])
#fertility
summary(fert_est[,2:11])

#plot them
#make colour palet
colpal <- brewer.pal(12,"Paired")
#survival
plot(surv_est[,2]~Age,surv_est,ylim=c(0,1),type="l") #Ache
lines(surv_est[,3],col=colpal[1]) #Agta
lines(surv_est[,4],col=colpal[2]) #Hadza
lines(surv_est[,5],col=colpal[3]) #Hiwi
lines(surv_est[,6],col=colpal[4]) #!Kung
lines(surv_est[,7],col=colpal[5]) #Aborigine
lines(surv_est[,8],col=colpal[6]) #Gainj
lines(surv_est[,9],col=colpal[7]) #Tsimane
lines(surv_est[,10],col=colpal[8]) #Yanomamo
lines(surv_est[11],col=colpal[9]) #Herero
#fertility
plot(fert_est[,2]~Age,fert_est,ylim=c(0,0.25),type="l") #Ache
lines(fert_est[,3],col=colpal[1]) #Agta
lines(fert_est[,4],col=colpal[2]) #Hadza
lines(fert_est[,5],col=colpal[3]) #Hiwi
lines(fert_est[,6],col=colpal[4]) #!Kung
lines(fert_est[,7],col=colpal[5]) #Aborigine
lines(fert_est[,8],col=colpal[6]) #Gainj
lines(fert_est[,9],col=colpal[7]) #Tsimane
lines(fert_est[,10],col=colpal[8]) #Yanomamo
lines(fert_est[11],col=colpal[9]) #Herero
```

#### First attempt: one life cycle stage, one resource dynamic.

An agent-based model is developed here with a population of 1000 individuals that have only one life cycle stage (i.e. reproductive career) and experience one resource dynamic (i.e. production). All individuals start with the maximum amount of resources that can be produced in one iteration (1) to ensure they can survive at initialisation.

First, the auxiliary variables are defined for the model. Auxiliary variables are fixed values set at initialisation that define the life-history and resource dynamics that individuals can experience. Regarding life-history dynamics, you define:

-   Age-specific survival cost (`surv_c_age`).
-   Age-specific cost of reproduction (`repro_c_age`).
-   Number of descendants per reproduction (`repro_n`).

Regarding resource dynamics, the auxiliary variables are:

-   Probability of production (`prod_p`).
-   Amount of resources produced (`prod_n`).

```{r}
#survival threshold
surv_thresh <- 1

#reproduction
#reproductive threshold
repro_thresh <- 10*surv_thresh
#number of descendants per reproduction
repro_n <- 1

#production
#probability
prod_p <- 0.75
#amount of resources produced
prod_n <- 2
```

The functions for state variables are defined to determine the dynamics each individual can experience in one year (i.e. one iteration). The functions for survival and age are defined here, followed by the discount on the amount of resources available due to the costs of survival. An individual can either survive (1) or not (0) in the survival function. An individual can survive (1) depending if the individual has enough resources to cover the age-specific costs of survival (`surv_c_age`) and samples from a uniform distribution a value lower than the sum of the probability of surviving (`die_p`) and the logarithm of the amount of resources available (`prod_a`). The influence of the amount of resources available is escaled to avoid an explosive population growth.

```{r}
survive <- function(it_indpop){
  if(it_indpop$prod_a[i] >= surv_thresh[b]){
      it_indpop$surv[i] <- 1
      } else{
      it_indpop$surv[i] <- 0
    }
  return(it_indpop$surv)
}

#age
age <- function(it_indpop){
  it_indpop$age[i] <- it_indpop$age[i]+it_indpop$surv[i]
  return(it_indpop$age)
}

#survival costs discount from resources
survive_c <- function(it_indpop){
    it_indpop$prod_a[i] <- it_indpop$prod_a[i]-surv_thresh[b]
  return(it_indpop$prod_a)
}
```

The functions for resource production and consumption are defined here. First is the probability of producing resources, then the amount of new resources, followed by the discount due to consumption. The production function tells if an individual produces new resources (1) or not (0), based on a binomial distribution. The probability in the binomial distribution is defined by the production probability in the auxiliary variables.

```{r}
#production
produce <- function(it_indpop){
  it_indpop$prod_o[i] <- rbinom(1,1,prod_p[b])
  return(it_indpop$prod_o)
}

#adding resources produced
produce_a <- function(it_indpop) {
  it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n
  return(it_indpop$prod_a)
}
```

The functions for the reproductive dynamics are defined here. First the probability of reproducing is defined, followed by the reproductive costs. The reproduction function tells if an individual reproduces (1) or not (0). An individual reproduces (1) depending if the individual has enough resources to cover the age-specific costs of reproduction (`repro_c_age`)and samples from a uniform distribution a value lower than the sum of the probability of reproducing (`repro_p`) and the logarithm of the amount of resources available (`prod_a`). The influence of the amount of resources available is scaled to avoid an explosive population growth.

```{r}
#reproduction probability
reproduce <- function(it_indpop){
  if(it_indpop$prod_a[i] >= repro_thresh[b]) {
      it_indpop$repro[i] <- 1
    } else{
      it_indpop$repro[i] <- 0
    }
  return(it_indpop$repro)
}

#reproductive cost discount from resources
reproduce_c <- function(it_indpop) {
  if(it_indpop$repro[i] == 1){
    it_indpop$prod_a[i] <- it_indpop$prod_a[i]-repro_thresh[b]
    }
  return(it_indpop$prod_a)
}

#lifetime reproductive output
reproduce_n <- function(it_indpop){
  it_indpop$lro[i] <- it_indpop$lro[i] + it_indpop$repro[i]
return(it_indpop$lro)
}

#add newborns
newborns <- function(new_it_indpop){
  if(sum(it_indpop$repro) > 0){
    new_it_indpop <- data.frame(id=max_id+1:sum(it_indpop[which(it_indpop$repro==1),"repro"]),surv=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),age=rep(10,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_o=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_a=rep(surv_thresh+repro_thresh,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),repro=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),lro=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"]))) #create data with newborns
    it_indpop <- rbind(it_indpop,new_it_indpop) #combine original population with newborns
  } else{
  new_it_indpop <- data.frame(id=NA,surv=NA,age=NA,prod_o=NA,prod_a=NA,repro=NA,lro=NA)
  }
  return(new_it_indpop)
}
```

Now that the life-history and resource dynamics functions are defined. They are used in a population of 1000 individuals that are 10 years old, only for one year. Additionally, two datasets are created to record the dynamics for each individual during one year (`it_indpop`) as well as record them through time (`it_data`). Other datasets are used to feed `it_data`, which are based on the survival outcome (`surv_data`), resource production (`resource_data`), and reproduction (`repro_data`).

```{r}
#create population
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(10,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(surv_thresh+repro_thresh,length.out=1000),repro=rep(NA,length.out=1000),lro=rep(0,length.out=1000))
#create iteration record
it_data <- data.frame(id=1:1000)

#run one iteration for all the population
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost,  production, and reproduction
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$prod_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$prod_a <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
}
#record production outcome and resources available
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data),full_join,by="id",suffix=c("0","1"))

#check the population by the end of the iteration
head(it_indpop)
#check the recorded data by the end of the iteration
head(it_data)

#check the population by the end of the iteration
head(it_indpop)
#check the recorded data by the end of the iteration
head(it_data)

```

After checking that the functions and databases work for one year, the model can be run for more years. Here we run the simulations for a 100 of years, resembling one generation of a population.

```{r}
#create population
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(10,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(surv_thresh+repro_thresh,length.out=1000),repro=rep(NA,length.out=1000),lro=rep(0,length.out=1000))
#create iteration record
it_data <- data.frame(id=1:1000)


#run 100 iterations
for (b in 1:100){
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost,  production, and reproduction
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$prod_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$prod_a <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
}
#record production outcome and resources available
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data),full_join,by="id",suffix=as.character(c(b-1,b)))
}

#check the population by the end of the iterations
head(it_indpop)

#check the age distribution by the end of the iterations
hist(it_indpop$age)
```

Now that there is a record for the survival, reproduction, and resource dynamics of each individual every year, it is possible to create the functions to calculate the different life-history traits and resource-dynamics of interest for each individual:

-   Longevity: number of years from birth to death.
-   Lifetime reproductive output (LRO): total number of descendants.
-   Age at first reproduction (AFR): age at which the individual has her first descendant.
-   Age at last reproduction (ALR): age at which the individual has her last descendant.

```{r}
#longevity
longevity <- function(final_ind_data){
  final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T))
  return(final_ind_data$lng)
}

#LRO
lro <- function(final_ind_data){
  final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T))
  return(final_ind_data$lro)
}

#AFR
afr <- function(final_ind_data){
  if(final_ind_data$lro[i] == 0){
    final_ind_data$afr[i] <- NA 
  }else{
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$afr)
}

#ALR
alr <- function(final_ind_data){
 if(final_ind_data$lro[i] == 0){
    final_ind_data$alr[i] <- NA 
  }else{
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$alr)
}
```

The functions for the lifetime resource dynamics of each individual are developed below. The dynamics that would be calculated are:

-   Lifetime production events: total number of positive outcomes (1) from the production function during the lifetime of an individual.
-   Lifetime consumption events: total number of consumption events during the lifetime of an individual. This amount should be the same as the age of an individual since consumption is fixed.
-   Lifetime resource production: total amount of resources produced during the lifetime of an individual.
-   Lifetime resource consumption: total amount of resources consumed during the lifetime of an individual.
-   Lifetime resources available: total amount of resources available during the lifetime of an individual.
-   Average resources available: average amount of resources available during the lifetime of an individual.
-   Variability resources available: variance of the amount of resources available during the lifetime of an individual.

```{r}
#production events
production_ev <- function(final_ind_data){
  final_ind_data$prod_ev[i] <- as.numeric(rowSums(it_data[i,grep("prod_o",colnames(it_data))],na.rm = T))
  return(final_ind_data$prod_ev)
}

#consumption events
consumption_ev <- function(final_ind_data){
  final_ind_data$cons_ev[i] <- final_ind_data$lng[i]
  return(final_ind_data$cons_ev)
}

#resource production
production_res <- function(final_ind_data){
  final_ind_data$prod_res[i] <- final_ind_data$prod_ev[i]*prod_n 
  return(final_ind_data$prod_res)
}

#resource consumption
consumption_res <- function(final_ind_data){
  final_ind_data$cons_res[i] <- final_ind_data$cons_ev[i]*cons_n
  return(final_ind_data$cons_res)
}

#resources available
available_res <- function(final_ind_data){
  final_ind_data$avai_res[i] <- as.numeric(rowSums(it_data[i,grep("prod_a",colnames(it_data))],na.rm=T))
  return(final_ind_data$avai_res)
}
  
#average resources available
available_av <- function(final_ind_data){
  final_ind_data$avai_av[i] <- mean(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_av)
}

#variance resources available
available_var <- function(final_ind_data){
  final_ind_data$avai_var[i] <- var(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_var)
  }
```

Once the functions to calculate the life-history traits and resource dynamics for each individual, it is possible to use them in the individuals from the population that was simulated for 100 years (`it_data`). The calculations for each individual are recorded in a separate database (`final_ind_data`).

```{r}
#create dataset
final_ind_data <- data.frame(id=1:nrow(it_data))

for(i in 1:nrow(it_data)){
  #life-history traits
  #longevity
final_ind_data$lng <- longevity(final_ind_data)
  #lro
final_ind_data$lro <- lro(final_ind_data)
  #afr
final_ind_data$afr <- afr(final_ind_data)
  #alr
final_ind_data$alr <- alr(final_ind_data)
  #resource dynamics
  #production events
final_ind_data$prod_ev <- production_ev(final_ind_data)
  #consumption events
final_ind_data$cons_ev <- consumption_ev(final_ind_data)
  #resource production
final_ind_data$prod_res <- production_res(final_ind_data)
  #resource consumption
final_ind_data$cons_res <- consumption_res(final_ind_data)
  #resources available
final_ind_data$avai_res <- available_res(final_ind_data)
  #average resources available
final_ind_data$avai_av <- available_av(final_ind_data)
  #variance resources available
final_ind_data$avai_var <- available_var(final_ind_data)
}

#plot it
#plot distributions of life-history traits
par(mfrow=c(2,2))
hist(final_ind_data$lng)
hist(final_ind_data$lro)
hist(final_ind_data$afr)
hist(final_ind_data$alr)
#plot distributions of resource dynamics
layout(matrix(c(1,1,2,2,3,3,4,4,0,5,5,6,6,7,7,0),nrow=2,byrow=TRUE))
hist(final_ind_data$prod_ev)
hist(final_ind_data$cons_ev)
hist(final_ind_data$prod_res)
hist(final_ind_data$cons_res)
hist(final_ind_data$avai_res)
hist(final_ind_data$avai_av)
hist(final_ind_data$avai_var)
#pairwise relationship 
pairs(~lng+lro+afr+alr+prod_ev+cons_ev+prod_res+cons_res+avai_res+avai_av+avai_var,data=final_ind_data)
#pairwise relationship of life-history traits with resource availability measurements
pairs(~lng+lro+afr+alr+avai_res+avai_av+avai_var,data=final_ind_data)
```

#### Second attempt: two life cycle stages, two resource dynamics.

An agent-based model is developed here with a population of 1000 individuals that have two life cycle stages (i.e. juvenile and reproductive career) and experience three resource dynamics (i.e. production and storage). The initial population will be half juveniles (n=500) and half individuals in their reproductive careers (n=500). All individuals start with the maximum amount of resources that can be produced in one iteration (1) to ensure they can survive at initialisation.

First, the auxiliary variables are defined for the model. Auxiliary variables are fixed values set at initialisation that define the life-history and resource dynamics that individuals can experience. Regarding life-history dynamics, they are stage-specific and defined as:

-   Age-specific survival cost (`surv_c_age`).
-   Age-specific cost of reproduction (`repro_c_age`).
-   Number of descendants per reproduction (`repro_n`).

Regarding resource dynamics, the auxiliary variables are also stage-specific and are defined as:

-   Stage-specific probability of production (`prod_p`).
-   Amount of resources produced (`prod_n`).

```{r}
#survival threshold
surv_thresh <- 1

#reproduction
#reproductive threshold
repro_thresh <- 10*surv_thresh
#number of descendants per reproduction
repro_n <- 1

#production
#probability
#juvenile
prod_p_j <- 0.75
#reproductive career
prod_p_rc <- 0.85
#amount of resources produced
#juvenile
prod_n_j <- 1
#reproductive career
prod_n_rc <- 2

store_age <- as.vector(rep(NA,length.out=100))
for(i in 1:length(store_age)){
  store_age[i] <- surv_thresh + prod_n_rc - repro_thresh
}
```

Now, the functions for the state variables are defined. First are the functions for life-history dynamics, followed by the ones related to resource dynamics. Each function is defined specifically for each life cycle stage. The functions for survival and age are defined first, followed by the discount on the amount of resources available due to the costs of survival. An individual can either survive (1) or not (0) in the survival function. An individual can survive (1) depending if the individual has enough resources to cover the age-specific costs of survival (`surv_c_age`) and samples from a uniform distribution a value lower than the sum of the age-specific probability of surviving (`die_p`) and the logarithm of the amount of resources stored (`store_a`). The influence of the amount of resources stored is escaled to avoid an explosive population growth.

```{r}
survive <- function(it_indpop){
  if(it_indpop$store_a[i] >= surv_thresh){
      it_indpop$surv[i] <- 1
      } else{
      it_indpop$surv[i] <- 0
    }
  return(it_indpop$surv)
}

#age
age <- function(it_indpop){
  it_indpop$age[i] <- it_indpop$age[i]+it_indpop$surv[i]
  return(it_indpop$age)
}

#survival costs discount from resources
survive_c <- function(it_indpop){
    it_indpop$store_a[i] <- it_indpop$store_a[i]-surv_thresh
  return(it_indpop$store_a)
}
```

The functions for resource production, consumption, and storage are defined here. First is the probability of producing resources, then the amount of new resources, followed by the discount due to consumption, and the probability of storing the resources available or not. The production and storage functions tell if an individual produces/storage new resources (1) or not (0), based on a binomial distribution. The probability in the binomial distribution is defined by the production and storage probabilities in the auxiliary variables, respectively.

```{r}
#production
produce <- function(it_indpop){
  if(it_indpop$stage[i]==1){ #juvenile
    it_indpop$prod_o[i] <- rbinom(1,1,prod_p_j)
  } else { #reproductive career
      it_indpop$prod_o[i] <- rbinom(1,1,prod_p_rc)
  }
  return(it_indpop$prod_o)
}

#adding resources produced
produce_a <- function(it_indpop){
    if(it_indpop$stage[i]==1){ #juvenile
    it_indpop$prod_a[i] <- it_indpop$prod_o[i]*prod_n_j
    } else{ #reproductive career
      it_indpop$prod_a[i] <- it_indpop$prod_o[i]*prod_n_rc
  }
  return(it_indpop$prod_a)
}

#storing resources produced
store_a <- function(it_indpop) {
  it_indpop$store_a[i] <- it_indpop$prod_a[i]
  it_indpop$prod_a[i] <- 0
  return(it_indpop)
}
```

The functions for the reproductive dynamics are defined here. This function is only for those individuals in the reproductive career stage. First the probability of reproducing is defined, followed by the reproductive costs. The reproduction function tells if an individual reproduces (1) or not (0). An individual reproduces (1) depending if the individual has enough resources to cover the age-specific costs of reproduction (`repro_c_age_rc`)and samples from a uniform distribution a value lower than the sum of the probability of reproducing (`repro_p_rc`) and the logarithm of the sum of resources availabledue to production (`prod_a`) and stored (`store_a`). The influence of the amount of resources available is scaled to avoid an explosive population growth. The probability of having the first descendant also depends on having enough resources to cover the age-specific survival costs and the reproductive costs at age 12 (emulating age at menarche).

```{r}
#reproduction probability
reproduce <- function(it_indpop){
  if(it_indpop$stage[i] == 2 & it_indpop$store_a[i] >= repro_thresh) {
      it_indpop$repro[i] <- 1
    } else{
      it_indpop$repro[i] <- 0
    }
  return(it_indpop$repro)
}

#reproductive cost discount from resources
reproduce_c <- function(it_indpop) {
  if(it_indpop$repro[i] == 1){
    it_indpop$store_a[i] <- it_indpop$store_a[i]-repro_thresh
    }
  return(it_indpop$store_a)
}

#lifetime reproductive output
reproduce_n <- function(it_indpop){
  it_indpop$lro[i] <- it_indpop$lro[i] + it_indpop$repro[i]
  return(it_indpop$lro)
}

#add newborns
newborns <- function(new_it_indpop){
  if(sum(it_indpop$repro) > 0){
    new_it_indpop <- data.frame(id=max_id+1:sum(it_indpop[which(it_indpop$repro==1),"repro"]),surv=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),age=rep(10,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_o=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_a=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),store_a=rep(surv_thresh,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),repro=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),lro=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),stage=rep(1,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"]))) #create data with newborns
    it_indpop <- rbind(it_indpop,new_it_indpop) #combine original population with newborns
  } else{
  new_it_indpop <- data.frame(id=NA,surv=NA,age=NA,prod_o=NA,prod_a=NA,store_a=NA,repro=NA,lro=NA,stage=NA)
  }
  return(new_it_indpop)
}
```

The function for the life cycle stage transition is defined here. The transition from juvenile to reproductive career stage is defined by the age at first reproduction. The life cycle stage transition would depend on whether the individual reproduces or not in the iteration (`repro`). The costs of transition are included in the reproduction function.

```{r}
#transition
transition <- function(it_indpop){
    if(it_indpop$stage[i]==1 & it_indpop$store_a[i] >= surv_thresh + repro_thresh){ #transition juvenile to reproductive career
      it_indpop$store_a[i] <- it_indpop$store_a[i]-repro_thresh
      it_indpop$repro[i] <- 1
      it_indpop$stage[i] <- 2
    }
  return(it_indpop$stage)
  }
```

Now that the life-history and resource dynamics functions are defined. They are used in a population of 1000 individuals only for one year. The population is structured by half of them in a juvenile stage (n=500) and half in their reproductive career stage (n=500). Additionally, two datasets are created to record the dynamics for each individual during one year (`it_indpop`) as well as record them through time (`it_data`). Other datasets are used to feed `it_data`, which are based on the survival outcome (`surv_data`), resource dynamics (`resource_data`), and reproduction (`repro_data`).

```{r}
#create population
#it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=c(rep(0,length.out=500),rep(10,length.out=500)),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=c(rep(surv_c_age[1],length.out=500),rep(surv_c_age[11],length.out=500)),repro=rep(NA,length.out=1000),stage=c(rep(1,length.out=500),rep(3,length.out=500)))
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(10,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=rep(surv_thresh,length.out=1000),repro=rep(NA,length.out=1000),lro=rep(0,length.out=1000),stage=rep(1,length.out=1000))
#create iteration record
it_data <- data.frame(id=1:1000)

#run one iteration for all the population
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#record life cycle stage of every individual
trans_data1 <- it_indpop[,c("id","stage")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost, and production
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$store_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
}
#record production outcome and resources produced
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#calculate resources available
for (i in 1:nrow(it_indpop)){
  #resources available
  it_indpop <- store_a(it_indpop)
}
#record resources available
resource_data$res_a <- it_indpop[,c("store_a")]
#calculate reproduction and transition
for (i in 1:nrow(it_indpop)){
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$store_a <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
  #transition
  it_indpop$stage <- transition(it_indpop)
}
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#record life cycle stage
trans_data2 <- it_indpop[,c("id","stage")]
#merge life cycle stage data
trans_data <- merge(trans_data1,trans_data2,by="id",all=T)
#change NAs into life cycle stage
trans_data[is.na(trans_data$stage.y),"stage.y"] <- trans_data[is.na(trans_data$stage.y),"stage.x"]
#clean life cycle stage data
trans_data <- trans_data[,c("id","stage.y")]
colnames(trans_data)[2] <- "stage"
#record stored to next iteration
resource_data$store_a <- it_indpop[,c("store_a")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data,trans_data),full_join,by="id",suffix=c("0","1"))

#check the population by the end of the iteration
head(it_indpop)
#check the recorded data by the end of the iteration
head(it_data)
```

After checking that the functions and databases work for one year, the model can be run for more years. Here we run the simulations for a 100 of years, resembling one generation of a population.

```{r}
#create population
#it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=c(rep(0,length.out=500),rep(10,length.out=500)),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=c(rep(surv_c_age[1],length.out=500),rep(surv_c_age[11],length.out=500)),repro=rep(NA,length.out=1000),stage=c(rep(1,length.out=500),rep(3,length.out=500)))
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(10,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=rep(surv_thresh,length.out=1000),repro=rep(NA,length.out=1000),lro=rep(0,length.out=1000),stage=rep(1,length.out=1000))

#create iteration record
it_data <- data.frame(id=1:1000)

#run 100 iterations
for (b in 1:100){
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#record life cycle stage of every individual
trans_data1 <- it_indpop[,c("id","stage")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost, and production
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$store_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
}
#record production outcome and resources produced
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#calculate resources available
for (i in 1:nrow(it_indpop)){
  #resources available
  it_indpop <- store_a(it_indpop)
}
#record resources available
resource_data$res_a <- it_indpop[,c("store_a")]
#calculate reproduction and transition
for (i in 1:nrow(it_indpop)){
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop$store_a <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
  #transition
  it_indpop$stage <- transition(it_indpop)
}
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#record life cycle stage
trans_data2 <- it_indpop[,c("id","stage")]
#merge life cycle stage data
trans_data <- merge(trans_data1,trans_data2,by="id",all=T)
#change NAs into life cycle stage
trans_data[is.na(trans_data$stage.y),"stage.y"] <- trans_data[is.na(trans_data$stage.y),"stage.x"]
#clean life cycle stage data
trans_data <- trans_data[,c("id","stage.y")]
colnames(trans_data)[2] <- "stage"
#record stored to next iteration
resource_data$store_a <- it_indpop[,c("store_a")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data,trans_data),full_join,by="id",suffix=as.character(c(b-1,b)))
}

#check the population by the end of the iterations
head(it_indpop)

#check the age distribution by the end of the iterations
hist(it_indpop$age)
```

Now that there is a record for the survival, reproduction, life cycle stage, and resource dynamics of each individual every year, it is possible to create the functions to calculate the different life-history traits and resource-dynamics of interest for each individual:

-   Longevity: number of years from birth to death.
-   Lifetime reproductive output (LRO): total number of descendants.
-   Age at first reproduction (AFR): age at which the individual has her first descendant. For individuals that are in their reproductive career stage at initialisation, it would be the age at their next descendant.
-   Age at last reproduction (ALR): age at which the individual has her last descendant.
-   Age at life cycle stage transition (Transition): age at which the individual transition from juvenile to reproductive career.

```{r}
#longevity
longevity <- function(final_ind_data){
  final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T))
  return(final_ind_data$lng)
}

#LRO
lro <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==2){
    final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) #you must have one descendant to be in the reproductive career stage
  } else{
    final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T))
  }
  return(final_ind_data$lro)
}

#AFR
afr <- function(final_ind_data){
  if(as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) == 0){
    final_ind_data$afr[i] <- NA 
  }else{
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$afr)
}

#ALR
alr <- function(final_ind_data){
 if(as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) == 0){
    final_ind_data$alr[i] <- NA 
  }else{
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1])
  }
  return(final_ind_data$alr)
}

#Transition
trans <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==1){
    if(as.numeric(rowSums(it_data[i,grep("stage",colnames(it_data))],na.rm = T)) == 0){
      final_ind_data$trans[i] <- NA
    } else{
      final_ind_data$trans[i] <- 
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])]==2])
    }
  } else{
    final_ind_data$trans[i] <- NA
  }
  return(final_ind_data$trans)
}
```


The functions for the lifetime resource dynamics of each individual are developed below. The dynamics that would be calculated are:

-   Lifetime production events: total number of positive outcomes (1) from the production function during the lifetime of an individual.
-   Lifetime resource production: total amount of resources produced during the lifetime of an individual.
-   Lifetime consumption events: total number of consumption events during the lifetime of an individual. This amount should be the same as the age of an individual since consumption is fixed.
-   Lifetime storage events: total number of storage events during the lifetime of an individual.
-   Lifetime resources produced: total amount of resources produced during the lifetime of an individual.
-   Lifetime resources consumed: total amount of resources consumed during the lifetime of an individual.
-   Lifetime resources stored: total amount of resources stored during the lifetime of an individual.
-   Lifetime resources available: total amount of resources available (different from stored) during the lifetime of an individual.
-   Average resources produced: average amount of resources produced during the lifetime of an individual.
-   Average resources consumed: average amount of resources consumed during the lifetime of an individual.
-   Average resources stored: average amount of resources stored during the lifetime of an individual.
-   Average resources available: average amount of resources available during the lifetime of an individual.
-   Variability resources produced: variance of the amount of resources produced during the lifetime of an individual.
-   Variability resources consumed: average amount of resources consumed during the lifetime of an individual.
-   Variability resources stored: variance of the amount of resources stored during the lifetime of an individual.
-   Variability resources available: variance of the amount of resources available during the lifetime of an individual.

```{r}
#Lifetime resources produced
production_res <- function(final_ind_data){
  final_ind_data$prod_res[i] <- as.numeric(rowSums(it_data[i,grep("prod_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$prod_res)
}

#Lifetime resources stored
storage_res <- function(final_ind_data){
  final_ind_data$store_res[i] <- as.numeric(rowSums(it_data[i,grep("store_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$store_res)
}

#Lifetime resources available
available_res <- function(final_ind_data){
  final_ind_data$avai_res[i] <- as.numeric(rowSums(it_data[i,grep("res_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$avai_res)
}

#Average resources produced
production_av <- function(final_ind_data){
  final_ind_data$prod_av[i] <- mean(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$prod_av)
}

#Average resources stored
storage_av <- function(final_ind_data){
  final_ind_data$store_av[i] <- mean(as.numeric(it_data[i,grep("store_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$store_av)
}

#Average resources available
available_av <- function(final_ind_data){
  final_ind_data$avai_av[i] <- mean(as.numeric(it_data[i,grep("res_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_av)
}

#Variability of resources produced
production_var <- function(final_ind_data){
  final_ind_data$prod_var[i] <- var(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$prod_var)
}

#Variability of resources stored
storage_var <- function(final_ind_data){
  final_ind_data$store_var[i] <- var(as.numeric(it_data[i,grep("store_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$store_var)
}

#Variability of resources available
available_var <- function(final_ind_data){
  final_ind_data$avai_var[i] <- var(as.numeric(it_data[i,grep("res_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_var)
}
```

Once the functions to calculate the life-history traits and resource dynamics for each individual, it is possible to use them in the individuals from the population that was simulated for 100 years (`it_data`). The calculations for each individual are recorded in a separate database (`final_ind_data`).

```{r}
#create dataset
final_ind_data <- data.frame(id=1:nrow(it_data))

for(i in 1:nrow(it_data)){
  #life-history traits
  #longevity
final_ind_data$lng <- longevity(final_ind_data)
  #lro
final_ind_data$lro <- lro(final_ind_data)
  #afr
final_ind_data$afr <- afr(final_ind_data)
  #alr
final_ind_data$alr <- alr(final_ind_data)
  #transition
final_ind_data$trans <- trans(final_ind_data)
  #resource dynamics
  #resources produced
final_ind_data$prod_res <- production_res(final_ind_data)
  #resources stored
final_ind_data$store_res <- storage_res(final_ind_data)
  #resources available
final_ind_data$avai_res <- available_res(final_ind_data)
  #average production
final_ind_data$prod_av <- production_av(final_ind_data)
  #average storage
final_ind_data$store_av <- storage_av(final_ind_data)
  #average available
final_ind_data$avai_av <- available_av(final_ind_data)
  #variability production
final_ind_data$prod_var <- production_var(final_ind_data)
  #variability storage
final_ind_data$store_var <- storage_var(final_ind_data)
  #variability available
final_ind_data$avai_var <- available_var(final_ind_data)
}

#plot it
#plot distributions of life-history traits
layout(matrix(c(1,1,2,2,3,3,0,4,4,5,5,0),nrow=2,byrow=TRUE))
hist(final_ind_data$lng)
hist(final_ind_data$lro)
hist(final_ind_data$afr)
hist(final_ind_data$alr)
#hist(final_ind_data$trans)
#plot distributions of resource dynamics
#layout(matrix(c(1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15),nrow=3,byrow=TRUE))
par(mfrow=c(3,5))
hist(final_ind_data$prod_ev)
hist(final_ind_data$cons_ev)
hist(final_ind_data$store_ev)
hist(final_ind_data$prod_res)
hist(final_ind_data$cons_res)
hist(final_ind_data$store_res)
hist(final_ind_data$avai_res)
hist(final_ind_data$prod_av)
hist(final_ind_data$cons_av)
hist(final_ind_data$store_av)
hist(final_ind_data$avai_av)
hist(final_ind_data$prod_var)
hist(final_ind_data$cons_var)
hist(final_ind_data$store_var)
hist(final_ind_data$avai_var)
#pairwise relationships
pairs(~lng+lro+afr+alr+prod_res+store_res+avai_res+prod_av+store_av+avai_av+prod_var+store_var+avai_var,data=final_ind_data)
#pairwise relationship of life-history traits with resource events
pairs(~lng+lro+afr+alr+trans+prod_ev+cons_ev+store_ev,data=final_ind_data)
#pairwise relationship of life-history traits with lifetime resources
pairs(~lng+lro+afr+alr+trans+prod_res+cons_res+store_res+avai_res,data=final_ind_data)
#pairwise relationship of life-history traits with average resources
pairs(~lng+lro+afr+alr+trans+prod_av+cons_av+store_av+avai_av,data=final_ind_data)
#pairwise relationship of life-history traits with variability of resources
pairs(~lng+lro+afr+alr+prod_var+store_var+avai_var,data=final_ind_data)
```

#### Third attempt: four life cycle stages, three resource dynamics.

An agent-based model is developed here with a population of 1000 individuals that have four life cycle stages (i.e. juvenile, adult, reproductive career, post-reproductive) and experience three resource dynamics (i.e. production, consumption, storage). The initial population will be a quarter of each life cycle stage (n=250). All individuals start with the maximum amount of resources that can be produced in one iteration (1) to ensure they can survive at initialisation.

First, the auxiliary variables are defined for the model. Auxiliary variables are fixed values set at initialisation that define the life-history and resource dynamics that individuals can experience. Regarding life-history dynamics, they are stage-specific and defined as:

-   Age-specific survival cost (`surv_c_age`).
-   Age-specific cost of reproduction (`repro_c_age`).
-   Number of descendants per reproduction (`repro_n`).

Regarding resource dynamics, the auxiliary variables are also stage-specific and are defined as:

-   Probability of production (`prod_p`).
-   Amount of resources produced (`prod_n`).
-   Probability of storage (`store_p`).

```{r}
#survival
#age-specific cost of surviving
surv_c_age <- as.vector(rep(NA,length.out=91))
for(i in 1:nrow(surv_est)){
  surv_c_age[i]<-(1-mean(as.numeric(surv_est[i,2:11])))
  }

#reproduction
#age-specific cost of reproduction
repro_c_age <- as.vector(rep(NA,length.out=91))
for(i in 1:nrow(fert_est)){
  repro_c_age[i]<-(1-mean(as.numeric(fert_est[i,2:11])))
  }
#number of descendants per reproduction
repro_n <- 1

#resource dynamics
total_c_age <- as.vector(rep(NA,length.out=91))
for(i in 1:length(total_c_age)){total_c_age[i]<-cumsum(surv_c_age)[i]+cumsum(repro_c_age)[i]}

prod_age <- as.vector(rep(NA,length.out=91))
for(i in 1:length(prod_age)){
  if(repro_c_age[i]==1){
    prod_age[i] <- 1.75
  } else{
    prod_age[i] <- 3.5
  }
}

left_res <- as.vector(rep(NA,length.out=91))
for(i in 1:length(left_res)){
     if(i== 1){
       left_res[i] <- 0.75
     } else{
   left_res[i] <- left_res[i-1]-cumsum(surv_c_age)[i]+prod_age[i]-cumsum(repro_c_age[i])  
     }
}
total_c_age
left_res
plot(total_c_age~c(0:90), xlab="Age",ylab="Resources",pch=16)
points(left_res, col="gold",pch=16)
points(cumsum(surv_c_age), col="blue")
points(cumsum(repro_c_age), col="red")
legend("topleft",legend=c("Total cost","Survival cost","Reproductive cost","Resources available"),col=c("black","blue","red","gold"),pch=c(16,1,1,16))

#calculating the amount of resources necessary to live until 90 and reproduce every year. After trying different values, 1.25 for the amount for infants and post-reproductive, and 2.5 for adults and reproductive career (double).

#juvenile

#production
#probability
prod_p_juv <- 0.75
#amount of resources produced
prod_n_juv <- 1.75

#adult

#production
#probability
prod_p_adu <- 0.9
#amount of resources produced
prod_n_adu <- 3.5

#reproductive career

#production
#probability
prod_p_rc <- 0.9
#amount of resources produced
prod_n_rc <- 3.5

#post-reproductive

#production
#probability
prod_p_post <- 0.8
#amount of resources produced
prod_n_post <- 1.75
```

Now, the functions for the state variables are defined. First are the functions for life-history dynamics, followed by the ones related to resource dynamics. Each function is defined specifically for each life cycle stage. The functions for survival and age are defined first, followed by the discount on the amount of resources available due to the costs of survival. An individual can either survive (1) or not (0) in the survival function. An individual can survive (1) depending if the individual has enough resources to cover the age-specific costs of survival (`surv_c_age`) and samples from a uniform distribution a value lower than the sum of the age-specific probability of surviving (`die_p`) and the logarithm of the amount of resources stored (`store_a`). The influence of the amount of resources stored is escaled to avoid an explosive population growth.

```{r}
#survival
survive <- function(it_indpop){
  if(it_indpop$age[i] >= 90){ #there are no values for 91
        it_indpop$surv[i] <- 0
    } else
        if(it_indpop$store_a[i] >= surv_c_age[it_indpop$age[i]+1]){
      it_indpop$surv[i] <- 1
      } else{
      it_indpop$surv[i] <- 0
    }
  return(it_indpop$surv)
}

#age
age <- function(it_indpop){
  it_indpop$age[i] <- it_indpop$age[i]+it_indpop$surv[i]
  return(it_indpop$age)
}

#survival costs discount from stored resources
survive_c <- function(it_indpop){
    it_indpop$store_a[i] <- it_indpop$store_a[i]-surv_c_age[it_indpop$age[i]]
  return(it_indpop$store_a)
}
```

The functions for resource production, consumption, and storage are defined here. First is the probability of producing resources, then the amount of new resources, followed by the discount due to consumption, and the probability of storing the resources available or not. The production and storage functions tell if an individual produces/storage new resources (1) or not (0), based on a binomial distribution. The probability in the binomial distribution is defined by the production and storage probabilities in the auxiliary variables, respectively.

```{r}
#production
produce <- function(it_indpop){
  if(it_indpop$stage[i]==0){ #juvenile
    it_indpop$prod_o[i] <- rbinom(1,1,prod_p_juv)
  } else
    if(it_indpop$stage[i]==1){ #adult
      it_indpop$prod_o[i] <- rbinom(1,1,prod_p_adu)
    } else 
      if(it_indpop$stage[i]==2){ #reproductive career
      it_indpop$prod_o[i] <- rbinom(1,1,prod_p_rc)
      } else{ #post-reproductive
      it_indpop$prod_o[i] <- rbinom(1,1,prod_p_post)
    }
  return(it_indpop$prod_o)
}

#adding resources produced to resources available
produce_a <- function(it_indpop){
    if(it_indpop$stage[i]==0){ #juvenile
    it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n_juv
  } else
    if(it_indpop$stage[i]==1){ #adult
      it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n_adu
    } else 
      if(it_indpop$stage[i]==2){ #reproductive career
      it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n_rc
      } else{ #post-reproductive
      it_indpop$prod_a[i] <- it_indpop$prod_a[i]+it_indpop$prod_o[i]*prod_n_post
    }
  return(it_indpop$prod_a)
}

#adding stored resources
store_a <- function(it_indpop) {
  it_indpop$store_a[i] <- it_indpop$prod_a[i]
  it_indpop$prod_a[i] <- 0
  return(it_indpop)
}
```

The functions for the reproductive dynamics are defined here. This function is only for those individuals in the reproductive career stage. First the probability of reproducing is defined, followed by the reproductive costs. The reproduction function tells if an individual reproduces (1) or not (0). An individual reproduces (1) depending if the individual has enough resources to cover the age-specific costs of reproduction (`repro_c_age_rc`)and samples from a uniform distribution a value lower than the sum of the probability of reproducing (`repro_p_rc`) and the logarithm of the sum of resources available due to production (`prod_a`) and stored (`store_a`). The influence of the amount of resources available is scaled to avoid an explosive population growth. The probability of having the first descendant also depends on having enough resources to cover the age-specific survival costs and the reproductive costs at age 12 (emulating age at menarche).

```{r}
#reproduction probability
reproduce <- function(it_indpop){
  if(it_indpop$stage[i]==2 & it_indpop$prod_a[i]+it_indpop$store_a[i] >= repro_c_age[it_indpop$age[i]+1]) {
      it_indpop$repro[i] <- 1
    } else{
      it_indpop$repro[i] <- 0
    }
  return(it_indpop$repro)
}

#age-specific reproductive costs discount
reproduce_c <- function(it_indpop) {
  if(it_indpop$repro[i] == 0){
    it_indpop$prod_a <- it_indpop$prod_a
    it_indpop$store_a <- it_indpop$store_a
  }else
    if(it_indpop$repro[i] == 1 & it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]>=0){
      it_indpop$prod_a[i] <- it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]
    }else{
      it_indpop$store_a[i] <- it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]+it_indpop$store_a[i]
    }
  return(it_indpop)
}

#lifetime reproductive output
reproduce_n <- function(it_indpop){
  if(it_indpop$repro[i] == 0){
    it_indpop$lro <- it_indpop$lro
  } else{
    it_indpop$lro <- it_indpop$lro + 1
  }
  return(it_indpop$lro)
}

#add newborns
newborns <- function(new_it_indpop){
  if(sum(it_indpop$repro) > 0){
    new_it_indpop <- data.frame(id=max_id+1:sum(it_indpop[which(it_indpop$repro==1),"repro"]),surv=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),age=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_o=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),prod_a=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),store_a=rep(surv_c_age[1],length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),repro=rep(NA,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"])),stage=rep(0,length.out=sum(it_indpop[which(it_indpop$repro==1),"repro"]))) #create data with newborns
    it_indpop <- rbind(it_indpop,new_it_indpop) #combine original population with newborns
  } else{
  new_it_indpop <- data.frame(id=NA,surv=NA,age=NA,prod_o=NA,prod_a=NA,store_a=NA,repro=NA,stage=NA)
  }
  return(new_it_indpop)
}
```

The function for the life cycle stage transition is defined here. The transition from juvenile (0) to adult (1) depends on the age at sexual maturity, which happens when an individual has enough resources to cover the sum of the age-specific survival (`surv_c_age`) and reproductive (`repro_c_age`) costs. The transition from adult (1) to reproductive career stage (2) is defined by the age at first reproduction, which happens when an individual can cover the age-specific survival  and reproductive costs. The transition from reproductive career (2) to post-reproductive (3) happens when an individual does not have enough resources to cover the sum of the age-specific survival and reproductive costs.

```{r}
#transition
transition <- function(it_indpop){
    if(it_indpop$stage[i]==0 & it_indpop$prod_a[i]+it_indpop$store_a[i] >= cumsum(surv_c_age)[11]+cumsum(repro_c_age)[11]){ #transition infant to adult
      it_indpop$stage[i] <- 1
  } else
#    if(it_indpop$stage[i]==0 & it_indpop$age[i]==15){ #transition infant to adult (forced)
#      it_indpop$stage[i] <- 1
#    } else
    if(it_indpop$stage[i]==1 & it_indpop$prod_a[i]+it_indpop$store_a[i] >= surv_c_age[it_indpop$age[i]+1]+repro_c_age[it_indpop$age[i]+1]){ #transition adult to reproductive career
       if(it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]>=0){ #discount reproductive cost to resources produced
      it_indpop$prod_a[i] <- it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]
      it_indpop$repro[i] <- 1
      it_indpop$stage[i] <- 2
    }else{ #discount reproductive cost to resources stored
      it_indpop$store_a[i] <- it_indpop$prod_a[i]-repro_c_age[it_indpop$age[i]+1]+it_indpop$store_a[i]
      it_indpop$repro[i] <- 1
      it_indpop$stage[i] <- 2
    } 
      } else
        if(it_indpop$stage[i]==1 & it_indpop$prod_a[i]+it_indpop$store_a[i] >= cumsum(surv_c_age)[51] & it_indpop$prod_a[i]+it_indpop$store_a[i] < cumsum(surv_c_age)[51]+cumsum(repro_c_age)[51]){ #transition adult to post-reproductive
        it_indpop$stage[i] <- 3
      } else 
      if(it_indpop$stage[i]==2 & it_indpop$prod_a[i]+it_indpop$store_a[i] >= cumsum(surv_c_age)[46] &  it_indpop$prod_a[i]+it_indpop$store_a[i] < cumsum(surv_c_age)[51]+cumsum(repro_c_age)[51]){ #transition reproductive career to post-reproductive career
          it_indpop$stage[i] <- 3
        } else {
      it_indpop$stage[i] <- it_indpop$stage[i]
      }
  return(it_indpop$stage)
  }

```

Now that the life-history and resource dynamics functions are defined. They are used in a population of 1000 individuals only for one year. The population is structured by 250 juveniles (age=0), 250 adults (age=11), 250 reproductive careers (age=15), and 250 post-reproductive individuals (age=45). Additionally, two datasets are created to record the dynamics for each individual during one year (`it_indpop`) as well as record them through time (`it_data`). Other datasets are used to feed `it_data`, which are based on the survival outcome (`surv_data`), resource dynamics (`resource_data`), reproduction (`repro_data`), and life cycle stage transition (`trans_data`).
 
```{r}
#create population
#it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=c(rep(0,length.out=250),rep(11,length.out=250),rep(15,length.out=250),rep(45,length.out=250)),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_o=rep(NA,length.out=1000),store_a=c(rep(surv_c_age[1],length.out=250),rep(surv_c_age[12],length.out=250),rep(surv_c_age[16],length.out=250),rep(surv_c_age[46],length.out=250)),repro=rep(NA,length.out=1000),stage=c(rep(0,length.out=250),rep(1,length.out=250),rep(2,length.out=250),rep(3,length.out=250)))
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(0,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=rep(surv_c_age[1],length.out=1000),repro=rep(NA,length.out=1000),stage=c(rep(0,length.out=1000)))

#create iteration record
it_data <- data.frame(id=1:1000)

#run one iteration for all the population
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#record life cycle stage of every individual
trans_data1 <- it_indpop[,c("id","stage")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost, and production
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$store_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
}
#record production outcome and resources produced
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#calculate reproduction and transition
for (i in 1:nrow(it_indpop)){
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
  #transition
  it_indpop$stage <- transition(it_indpop)
}
#record resources available
resource_data$res_a <- it_indpop[,c("prod_a")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#record life cycle stage
trans_data2 <- it_indpop[,c("id","stage")]
#merge life cycle stage data
trans_data <- merge(trans_data1,trans_data2,by="id",all=T)
#change NAs into life cycle stage
trans_data[is.na(trans_data$stage.y),"stage.y"] <- trans_data[is.na(trans_data$stage.y),"stage.x"]
#clean life cycle stage data
trans_data <- trans_data[,c("id","stage.y")]
colnames(trans_data)[2] <- "stage"
#calculate storage
for (i in 1:nrow(it_indpop)){
  #stor resources
  it_indpop <- store_a(it_indpop)
}
#record resource storage
resource_data[,c("store_a")] <- it_indpop[,c("store_a")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data,trans_data),full_join,by="id",suffix=c("0","1"))

#check the population by the end of the iteration
head(it_indpop)
#check the recorded data by the end of the iteration
head(it_data)
```

After checking that the functions and databases work for one year, the model can be run for more years. Here we run the simulations for a 90 of years, resembling one generation of a population.

```{r}
#create population
#it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=c(rep(0,length.out=250),rep(11,length.out=250),rep(15,length.out=250),rep(45,length.out=250)),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_o=rep(NA,length.out=1000),store_a=c(rep(cumsum(surv_c_age)[1],length.out=250),rep(cumsum(surv_c_age)[12],length.out=250),rep(cumsum(surv_c_age)[16],length.out=250),rep(cumsum(surv_c_age)[46],length.out=250)),repro=rep(NA,length.out=1000),stage=c(rep(0,length.out=250),rep(1,length.out=250),rep(2,length.out=250),rep(3,length.out=250)))
it_indpop <- data.frame(id=1:1000,surv=rep(NA,length.out=1000),age=rep(0,length.out=1000),prod_o=rep(NA,length.out=1000),prod_a=rep(0,length.out=1000),store_a=rep(surv_c_age[1],length.out=1000),repro=rep(NA,length.out=1000),stage=c(rep(0,length.out=1000)))
#create iteration record
it_data <- data.frame(id=1:1000)

#run 90 iterations
for (b in 1:90){
#record the maximum id
max_id <- max(it_indpop$id)
#calculate the survival outcome
for (i in 1:nrow(it_indpop)){
  #survival
  it_indpop$surv <- survive(it_indpop)
}
#record survival outcome
surv_data <- it_indpop[,c("id","surv")]
#record life cycle stage of every individual
trans_data1 <- it_indpop[,c("id","stage")]
#keep individuals that survived
it_indpop <- it_indpop[it_indpop$surv==1,]
#calculate age, survival cost, and production
for (i in 1:nrow(it_indpop)){
  #age
  it_indpop$age <- age(it_indpop)
  #survival cost
  it_indpop$store_a <- survive_c(it_indpop)
  #production outcome
  it_indpop$prod_o <- produce(it_indpop)
  #production amount
  it_indpop$prod_a <- produce_a(it_indpop)
}
#record production outcome and resources produced
resource_data <- it_indpop[,c("id","prod_o","prod_a")]
#calculate reproduction and transition
for (i in 1:nrow(it_indpop)){
  #reproduction probability
  it_indpop$repro <- reproduce(it_indpop)
  #reproductive cost
  it_indpop <- reproduce_c(it_indpop)
  #lifetime reproductive output
  it_indpop$lro <- reproduce_n(it_indpop)
  #transition
  it_indpop$stage <- transition(it_indpop)
}
#record resources available
resource_data$res_a <- it_indpop[,c("prod_a")]
#record reproduction
repro_data <- it_indpop[,c("id","repro")]
#record life cycle stage
trans_data2 <- it_indpop[,c("id","stage")]
#merge life cycle stage data
trans_data <- merge(trans_data1,trans_data2,by="id",all=T)
#change NAs into life cycle stage
trans_data[is.na(trans_data$stage.y),"stage.y"] <- trans_data[is.na(trans_data$stage.y),"stage.x"]
#clean life cycle stage data
trans_data <- trans_data[,c("id","stage.y")]
colnames(trans_data)[2] <- "stage"
#calculate storage
for (i in 1:nrow(it_indpop)){
  #stor resources
  it_indpop <- store_a(it_indpop)
}
#record resource storage
resource_data[,c("store_a")] <- it_indpop[,c("store_a")]
#add newborns
new_it_indpop <- newborns(new_it_indpop)
#combine original population with newborns
it_indpop <- rbind(it_indpop,new_it_indpop)
#remove NA in id
it_indpop <- it_indpop[!is.na(it_indpop$id),]
#merge iteration records
it_data <- reduce(list(it_data,surv_data,repro_data,resource_data,trans_data),full_join,by="id",suffix=as.character(c(b-1,b)))
}

#check the population by the end of the iterations
head(it_indpop)

#check the age distribution by the end of the iterations
hist(it_indpop$age)
```


Now that there is a record for the survival, reproduction, life cycle stage, and resource dynamics of each individual every year, it is possible to create the functions to calculate the different life-history traits and resource-dynamics of interest for each individual:

-   Longevity: number of years from birth to death.
-   Lifetime reproductive output (LRO): total number of descendants.
-   Age at sexual maturity: age at which the individual transition from juvenile to adult stage.
-   Age at first reproduction (AFR): age at which the individual has her first descendant. For individuals that are in their reproductive career stage at initialisation, it would be the age at their next descendant.
-   Age at last reproduction (ALR): age at which the individual has her last descendant.
-   Age at menopause: age at which the individual transition from reproductive career to post-reproductive stage.

```{r}
#longevity
longevity <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==1){ #longevity of adults
    final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T)) + 10
  } else 
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==2){ #longevity of reproductive career
    final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T)) + 15
  } else
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==3){ #longevity of post-reproductive
    final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T)) + 45  
    } else{
      final_ind_data$lng[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T))
    }
  return(final_ind_data$lng)
}

#LRO
lro <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==2){
    final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) + 1 #you must have one descendant to be in the reproductive career stage
  } else{
    final_ind_data$lro[i] <- as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T))
  }
  return(final_ind_data$lro)
}

#Age at sexual maturity
asm <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==0 & as.numeric(rowSums(it_data[i,grep("stage",colnames(it_data))],na.rm = T)) > 0){
      final_ind_data$asm[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])]==1])
    } else{
    final_ind_data$asm[i] <- NA
  }
  return(final_ind_data$asm)
}

#AFR
afr <- function(final_ind_data){
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==1 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #AFR of adults
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 10
  } else 
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==2 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #AFR of reproductive career
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 15
  } else
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==3 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #AFR of post-reproductive
    final_ind_data$afr[i] <-
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 45  
    } else
      if(as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) == 0){
      final_ind_data$afr[i] <- NA 
  }else{
    final_ind_data$afr[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T))
    }
  return(final_ind_data$afr)
}

#ALR
alr <- function(final_ind_data){
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==1 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #ALR of adults
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 10
  } else 
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==2 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #ALR of reproductive career
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 15
  } else
    if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==3 &  as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) > 0){ #ALR of post-reproductive
    final_ind_data$alr[i] <-
    max(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("repro",colnames(it_data))][!is.na(it_data[i,grep("repro",colnames(it_data))])]==1]) + 45  
    } else
      if(as.numeric(rowSums(it_data[i,grep("repro",colnames(it_data))],na.rm = T)) == 0){
      final_ind_data$alr[i] <- NA 
  }else{
    final_ind_data$alr[i] <- as.numeric(rowSums(it_data[i,grep("surv",colnames(it_data))],na.rm = T))
    }
  return(final_ind_data$alr)
}

#Age at menopause
meno <- function(final_ind_data){
  if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]!=3 & min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])]==3]) != Inf){
    final_ind_data$meno[i] <- 
    min(cumsum(it_data[i,grep("surv",colnames(it_data))][!is.na(it_data[i,grep("surv",colnames(it_data))])])[it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])]==3])
    } else
      if(it_data[i,grep("stage",colnames(it_data))][!is.na(it_data[i,grep("stage",colnames(it_data))])][1]==3){
      final_ind_data$meno[i] <- 45  
      } else{
      final_ind_data$meno[i] <- NA
    }
  return(final_ind_data$meno)
}

```


The functions for the lifetime resource dynamics of each individual are developed below. The dynamics that would be calculated are:

-   Lifetime production events: total number of positive outcomes (1) from the production function during the lifetime of an individual.
-   Lifetime resource production: total amount of resources produced during the lifetime of an individual.
-   Lifetime consumption events: total number of consumption events during the lifetime of an individual. This amount should be the same as the age of an individual since consumption is fixed.
-   Lifetime storage events: total number of storage events during the lifetime of an individual.
-   Lifetime resources produced: total amount of resources produced during the lifetime of an individual.
-   Lifetime resources consumed: total amount of resources consumed during the lifetime of an individual.
-   Lifetime resources stored: total amount of resources stored during the lifetime of an individual.
-   Lifetime resources available: total amount of resources available (different from stored) during the lifetime of an individual.
-   Average resources produced: average amount of resources produced during the lifetime of an individual.
-   Average resources consumed: average amount of resources consumed during the lifetime of an individual.
-   Average resources stored: average amount of resources stored during the lifetime of an individual.
-   Average resources available: average amount of resources available during the lifetime of an individual.
-   Variability resources produced: variance of the amount of resources produced during the lifetime of an individual.
-   Variability resources consumed: average amount of resources consumed during the lifetime of an individual.
-   Variability resources stored: variance of the amount of resources stored during the lifetime of an individual.
-   Variability resources available: variance of the amount of resources available during the lifetime of an individual.

```{r}
#Lifetime production events
production_ev <- function(final_ind_data){
  final_ind_data$prod_ev[i] <- as.numeric(rowSums(it_data[i,grep("prod_o",colnames(it_data))],na.rm = T))
  return(final_ind_data$prod_ev)
}

#Lifetime consumption events
consumption_ev <- function(final_ind_data){
  final_ind_data$cons_ev[i] <- final_ind_data$lng[i]
  return(final_ind_data$cons_ev)
}

#Lifetime storage events
storage_ev <- function(final_ind_data){
  final_ind_data$store_ev[i] <- as.numeric(rowSums(it_data[i,grep("store_o",colnames(it_data))],na.rm = T))
  return(final_ind_data$store_ev)
}

#Lifetime resources produced
production_res <- function(final_ind_data){
  final_ind_data$prod_res[i] <- as.numeric(rowSums(it_data[i,grep("prod_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$prod_res)
}

#Lifetime resources consumed
consumption_res <- function(final_ind_data){
  final_ind_data$cons_res[i] <- as.numeric(rowSums(it_data[i,grep("cons",colnames(it_data))],na.rm = T))
  return(final_ind_data$cons_res)
}

#Lifetime resources stored
storage_res <- function(final_ind_data){
  final_ind_data$store_res[i] <- as.numeric(rowSums(it_data[i,grep("store_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$store_res)
}

#Lifetime resources available
available_res <- function(final_ind_data){
  final_ind_data$avai_res[i] <- as.numeric(rowSums(it_data[i,grep("res_a",colnames(it_data))],na.rm = T))
  return(final_ind_data$avai_res)
}

#Average resources produced
production_av <- function(final_ind_data){
  final_ind_data$prod_av[i] <- mean(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$prod_av)
}

#Average resources consumed
consumption_av <- function(final_ind_data){
  final_ind_data$cons_av[i] <- mean(as.numeric(it_data[i,grep("cons",colnames(it_data))]),na.rm = T)
  return(final_ind_data$cons_av)
}

#Average resources stored
storage_av <- function(final_ind_data){
  final_ind_data$store_av[i] <- mean(as.numeric(it_data[i,grep("store_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$store_av)
}

#Average resources available
available_av <- function(final_ind_data){
  final_ind_data$avai_av[i] <- mean(as.numeric(it_data[i,grep("res_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_av)
}

#Variability of resources produced
production_var <- function(final_ind_data){
  final_ind_data$prod_var[i] <- var(as.numeric(it_data[i,grep("prod_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$prod_var)
}

#Average resources consumed
consumption_var <- function(final_ind_data){
  final_ind_data$cons_var[i] <- var(as.numeric(it_data[i,grep("cons",colnames(it_data))]),na.rm = T)
  return(final_ind_data$cons_var)
}

#Variability of resources stored
storage_var <- function(final_ind_data){
  final_ind_data$store_var[i] <- var(as.numeric(it_data[i,grep("store_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$store_var)
}

#Variability of resources available
available_var <- function(final_ind_data){
  final_ind_data$avai_var[i] <- var(as.numeric(it_data[i,grep("res_a",colnames(it_data))]),na.rm = T)
  return(final_ind_data$avai_var)
}
```

Once the functions to calculate the life-history traits and resource dynamics for each individual, it is possible to use them in the individuals from the population that was simulated for 100 years (`it_data`). The calculations for each individual are recorded in a separate database (`final_ind_data`).

```{r}
#create dataset
final_ind_data <- data.frame(id=1:nrow(it_data))

for(i in 1:nrow(it_data)){
  #life-history traits
  #longevity
final_ind_data$lng <- longevity(final_ind_data)
#   #lro
 final_ind_data$lro <- lro(final_ind_data)
#   #asm
 final_ind_data$asm <- asm(final_ind_data)
#   #afr
 final_ind_data$afr <- afr(final_ind_data)
#   #alr
 final_ind_data$alr <- alr(final_ind_data)
#   #menopause
  final_ind_data$meno <- meno(final_ind_data)
#   #resource dynamics
#   #production events
 final_ind_data$prod_ev <- production_ev(final_ind_data)
#   #consumption events
# final_ind_data$cons_ev <- consumption_ev(final_ind_data)
#   #storage events
 final_ind_data$store_ev <- storage_ev(final_ind_data)
#   #resources produced
 final_ind_data$prod_res <- production_res(final_ind_data)
#   #resources consumed
# final_ind_data$cons_res <- consumption_res(final_ind_data)
#   #resources stored
 final_ind_data$store_res <- storage_res(final_ind_data)
#   #resources available
 final_ind_data$avai_res <- available_res(final_ind_data)
#   #average production
 final_ind_data$prod_av <- production_av(final_ind_data)
#   #average consumption
# final_ind_data$cons_av <- consumption_av(final_ind_data)
#   #average storage
 final_ind_data$store_av <- storage_av(final_ind_data)
#   #average available
 final_ind_data$avai_av <- available_av(final_ind_data)
#   #variability production
 final_ind_data$prod_var <- production_var(final_ind_data)
#   #variability consumption
# final_ind_data$cons_var <- consumption_var(final_ind_data)
#   #variability storage
 final_ind_data$store_var <- storage_var(final_ind_data)
#   #variability available
 final_ind_data$avai_var <- available_var(final_ind_data)
}

#plot it
#plot distributions of life-history traits
# layout(matrix(c(1,1,2,2,3,3,4,4,5,5,6,6),nrow=2,byrow=TRUE))
# hist(final_ind_data$lng)
# hist(final_ind_data$lro)
# hist(final_ind_data$asm)
# hist(final_ind_data$afr)
# hist(final_ind_data$alr)
# hist(final_ind_data$meno)
#plot distributions of resource dynamics
#layout(matrix(c(1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15),nrow=3,byrow=TRUE))
# par(mfrow=c(3,5))
# hist(final_ind_data$prod_ev)
# hist(final_ind_data$cons_ev)
# hist(final_ind_data$store_ev)
# hist(final_ind_data$prod_res)
# hist(final_ind_data$cons_res)
# hist(final_ind_data$store_res)
# hist(final_ind_data$avai_res)
# hist(final_ind_data$prod_av)
# hist(final_ind_data$cons_av)
# hist(final_ind_data$store_av)
# hist(final_ind_data$avai_av)
# hist(final_ind_data$prod_var)
# hist(final_ind_data$cons_var)
# hist(final_ind_data$store_var)
# hist(final_ind_data$avai_var)
#pairwise relationships
# pairs(~lng+lro+asm+afr+alr+meno+prod_ev+cons_ev+store_ev+prod_res+cons_res+store_res+avai_res+prod_av+cons_av+store_av+avai_av+prod_var+cons_var+store_var+avai_var,data=final_ind_data)
#pairwise relationship of life-history traits with resource events
# pairs(~lng+lro+asm+afr+alr+meno+prod_ev+cons_ev+store_ev,data=final_ind_data)
#pairwise relationship of life-history traits with lifetime resources
#pairs(~lng+lro+asm+afr+alr+meno+prod_res+cons_res+store_res+avai_res,data=final_ind_data)
#pairwise relationship of life-history traits with average resources
#pairs(~lng+lro+asm+afr+alr+meno+prod_av+cons_av+store_av+avai_av,data=final_ind_data)
#pairwise relationship of life-history traits with variability of resources
#pairs(~lng+lro+asm+afr+alr+meno+prod_var+cons_var+store_var+avai_var,data=final_ind_data)
```

### Parameters exploration

#### Two life cycle stages: juvenile to reproductive career

```{r}
#define survival effort
surv_effort <- c(0.1,seq(0.25,1,0.25))
#define the proportion between survival and reproductive effort
proportion <- c(0.5,seq(1,10,1))
#combinations of survival effort and proportion
comb <- expand.grid(surv_effort,proportion)
#define reproductive effort
repro_effort <- apply(comb,1,prod)
#define the reproductive threshold
repro_thresh <- sapply(comb[,1],function(x) x*10)
#define the amount of resources you can produce
prod_stage <- c(1,2)

#check the life cycles with the combinations of survival and reproductive effort
for(b in 1:nrow(comb)){
 data <- data.frame(stored_res=c(0.5,rep(0,length.out=100)),prod_age=rep(0,length.out=101),repro_ev=rep(0,length.out=101))
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age[i] <- prod_stage[1]
     data$stored_res[i] <- data$stored_res[i]-comb[b,1]+data$prod_age[i]
   }else{
     if(sum(data$repro_ev) == 0 & data$stored_res[i-1] < repro_thresh[b]){
       data$prod_age[i] <- prod_stage[1]
       data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
     }else{
       if(data$stored_res[i-1] < repro_thresh[b]){
       data$prod_age[i] <- prod_stage[2]  
       data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
       }else{
       data$repro_ev[i] <- 1
       data$prod_age[i] <- prod_stage[2]
       data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
       }
     }
   }
 }
 plot(data$stored_res~c(1:101),xlab=b)
 points(data$prod_age,pch=16)
 abline(v=which(data$repro_ev==1))
}

#check the combinations that gave more realistic outputs
comb[c(23,28,33,38,43,48,53),]
#arrange plots
layout(matrix(c(1,1,2,2,3,3,4,4,0,5,5,6,6,7,7,0), nrow=2, byrow=TRUE))
#comb[23,], surv_effort=0.5,repro_effort=2
data <- data.frame(stored_res23=c(0.5,rep(0,length.out=100)),prod_age23=rep(0,length.out=101),repro_ev23=rep(0,length.out=101))
#calculate
 for(i in 1:ncol(data)){
   if(i == 1){
     data$prod_age23[i] <- prod_stage[1]
     data$stored_res23[i] <- data$stored_res23[i]-comb[23,1]+data$prod_age23[i]
   }else{
     if(sum(data$repro_ev23) == 0 & data$stored_res23[i-1] < repro_thresh[23]){
       data$prod_age23[i] <- prod_stage[1]
       data$stored_res23[i] <- data$stored_res23[i-1]-comb[23,1]+data$prod_age23[i]
     }else{
       if(data$stored_res23[i-1] < repro_thresh[23]){
       data$prod_age23[i] <- prod_stage[2]  
       data$stored_res23[i] <- data$stored_res23[i-1]-comb[23,1]+data$prod_age23[i]
       }else{
       data$repro_ev23[i] <- 1
       data$prod_age23[i] <- prod_stage[2]
       data$stored_res23[i] <- data$stored_res23[i-1]-comb[23,1]+data$prod_age23[i]-repro_effort[23]
       }
     }
   }
 }
#plot it
plot(data$stored_res23~c(1:101),xlab="surv_effort=0.5,repro_effort=2",ylim=c(0,7))
 points(data$prod_age23,pch=16)
 abline(v=which(data$repro_ev23==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[28,], surv_effort=0.5,repro_effort=2.5
data <- cbind(data,data.frame(stored_res28=c(0.5,rep(0,length.out=100)),prod_age28=rep(0,length.out=101),repro_ev28=rep(0,length.out=101)))
 #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age28[i] <- prod_stage[1]
     data$stored_res28[i] <- data$stored_res28[i]-comb[28,1]+data$prod_age28[i]
   }else{
     if(sum(data$repro_ev28) == 0 & data$stored_res28[i-1] < repro_thresh[28]){
       data$prod_age28[i] <- prod_stage[1]
       data$stored_res28[i] <- data$stored_res28[i-1]-comb[28,1]+data$prod_age28[i]
     }else{
       if(data$stored_res28[i-1] < repro_thresh[28]){
       data$prod_age28[i] <- prod_stage[2]  
       data$stored_res28[i] <- data$stored_res28[i-1]-comb[28,1]+data$prod_age28[i]
       }else{
       data$repro_ev28[i] <- 1
       data$prod_age28[i] <- prod_stage[2]
       data$stored_res28[i] <- data$stored_res28[i-1]-comb[28,1]+data$prod_age28[i]-repro_effort[28]
       }
     }
   }
 }
#plot it
plot(data$stored_res28~c(1:101),xlab="surv_effort=0.5,repro_effort=2.5",ylim=c(0,7))
 points(data$prod_age28,pch=16)
 abline(v=which(data$repro_ev28==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[33,], surv_effort=0.5,repro_effort=3
data <- cbind(data,data.frame(stored_res33=c(0.5,rep(0,length.out=100)),prod_age33=rep(0,length.out=101),repro_ev33=rep(0,length.out=101)))
 #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age33[i] <- prod_stage[1]
     data$stored_res33[i] <- data$stored_res33[i]-comb[33,1]+data$prod_age33[i]
   }else{
     if(sum(data$repro_ev33) == 0 & data$stored_res33[i-1] < repro_thresh[33]){
       data$prod_age33[i] <- prod_stage[1]
       data$stored_res33[i] <- data$stored_res33[i-1]-comb[33,1]+data$prod_age33[i]
     }else{
       if(data$stored_res33[i-1] < repro_thresh[33]){
       data$prod_age33[i] <- prod_stage[2]  
       data$stored_res33[i] <- data$stored_res33[i-1]-comb[33,1]+data$prod_age33[i]
       }else{
       data$repro_ev33[i] <- 1
       data$prod_age33[i] <- prod_stage[2]
       data$stored_res33[i] <- data$stored_res33[i-1]-comb[33,1]+data$prod_age33[i]-repro_effort[33]
       }
     }
   }
 }
#plot it
plot(data$stored_res33~c(1:101),xlab="surv_effort=0.5,repro_effort=3",ylim=c(0,7))
 points(data$prod_age33,pch=16)
 abline(v=which(data$repro_ev33==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[38,], surv_effort=0.5,repro_effort=3.5
data <- cbind(data,data.frame(stored_res38=c(0.5,rep(0,length.out=100)),prod_age38=rep(0,length.out=101),repro_ev38=rep(0,length.out=101)))
 #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age38[i] <- prod_stage[1]
     data$stored_res38[i] <- data$stored_res38[i]-comb[38,1]+data$prod_age38[i]
   }else{
     if(sum(data$repro_ev38) == 0 & data$stored_res38[i-1] < repro_thresh[38]){
       data$prod_age38[i] <- prod_stage[1]
       data$stored_res38[i] <- data$stored_res38[i-1]-comb[38,1]+data$prod_age38[i]
     }else{
       if(data$stored_res38[i-1] < repro_thresh[38]){
       data$prod_age38[i] <- prod_stage[2]  
       data$stored_res38[i] <- data$stored_res38[i-1]-comb[38,1]+data$prod_age38[i]
       }else{
       data$repro_ev38[i] <- 1
       data$prod_age38[i] <- prod_stage[2]
       data$stored_res38[i] <- data$stored_res38[i-1]-comb[38,1]+data$prod_age38[i]-repro_effort[38]
       }
     }
   }
 }
#plot it
plot(data$stored_res38~c(1:101),xlab="surv_effort=0.5,repro_effort=3.5",ylim=c(0,7))
 points(data$prod_age38,pch=16)
 abline(v=which(data$repro_ev38==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[43,], surv_effort=0.5,repro_effort=4
data <- cbind(data,data.frame(stored_res43=c(0.5,rep(0,length.out=100)),prod_age43=rep(0,length.out=101),repro_ev43=rep(0,length.out=101)))
 #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age43[i] <- prod_stage[1]
     data$stored_res43[i] <- data$stored_res43[i]-comb[43,1]+data$prod_age43[i]
   }else{
     if(sum(data$repro_ev43) == 0 & data$stored_res43[i-1] < repro_thresh[43]){
       data$prod_age43[i] <- prod_stage[1]
       data$stored_res43[i] <- data$stored_res43[i-1]-comb[43,1]+data$prod_age43[i]
     }else{
       if(data$stored_res43[i-1] < repro_thresh[43]){
       data$prod_age43[i] <- prod_stage[2]  
       data$stored_res43[i] <- data$stored_res43[i-1]-comb[43,1]+data$prod_age43[i]
       }else{
       data$repro_ev43[i] <- 1
       data$prod_age43[i] <- prod_stage[2]
       data$stored_res43[i] <- data$stored_res43[i-1]-comb[43,1]+data$prod_age43[i]-repro_effort[43]
       }
     }
   }
 }
#plot it
plot(data$stored_res43~c(1:101),xlab="surv_effort=0.5,repro_effort=4",ylim=c(0,7))
 points(data$prod_age43,pch=16)
 abline(v=which(data$repro_ev43==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[48,], surv_effort=0.5,repro_effort=4.5
data <- cbind(data,data.frame(stored_res48=c(0.5,rep(0,length.out=100)),prod_age48=rep(0,length.out=101),repro_ev48=rep(0,length.out=101)))
  #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age48[i] <- prod_stage[1]
     data$stored_res48[i] <- data$stored_res48[i]-comb[48,1]+data$prod_age48[i]
   }else{
     if(sum(data$repro_ev48) == 0 & data$stored_res48[i-1] < repro_thresh[48]){
       data$prod_age48[i] <- prod_stage[1]
       data$stored_res48[i] <- data$stored_res48[i-1]-comb[48,1]+data$prod_age48[i]
     }else{
       if(data$stored_res48[i-1] < repro_thresh[48]){
       data$prod_age48[i] <- prod_stage[2]  
       data$stored_res48[i] <- data$stored_res48[i-1]-comb[48,1]+data$prod_age48[i]
       }else{
       data$repro_ev48[i] <- 1
       data$prod_age48[i] <- prod_stage[2]
       data$stored_res48[i] <- data$stored_res48[i-1]-comb[48,1]+data$prod_age48[i]-repro_effort[48]
       }
     }
   }
 }
#plot it
plot(data$stored_res48~c(1:101),xlab="surv_effort=0.5,repro_effort=4.5",ylim=c(0,7))
 points(data$prod_age48,pch=16)
 abline(v=which(data$repro_ev48==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#comb[53,], surv_effort=0.5,repro_effort=5
data <- cbind(data,data.frame(stored_res53=c(0.5,rep(0,length.out=100)),prod_age53=rep(0,length.out=101),repro_ev53=rep(0,length.out=101)))
 #calculate
 for(i in 1:nrow(data)){
   if(i == 1){
     data$prod_age53[i] <- prod_stage[1]
     data$stored_res53[i] <- data$stored_res53[i]-comb[53,1]+data$prod_age53[i]
   }else{
     if(sum(data$repro_ev53) == 0 & data$stored_res53[i-1] < repro_thresh[53]){
       data$prod_age53[i] <- prod_stage[1]
       data$stored_res53[i] <- data$stored_res53[i-1]-comb[53,1]+data$prod_age53[i]
     }else{
       if(data$stored_res53[i-1] < repro_thresh[53]){
       data$prod_age53[i] <- prod_stage[2]  
       data$stored_res53[i] <- data$stored_res53[i-1]-comb[53,1]+data$prod_age53[i]
       }else{
       data$repro_ev53[i] <- 1
       data$prod_age53[i] <- prod_stage[2]
       data$stored_res53[i] <- data$stored_res53[i-1]-comb[53,1]+data$prod_age53[i]-repro_effort[53]
       }
     }
   }
 }
#plot it
plot(data$stored_res53~c(1:101),xlab="surv_effort=0.5,repro_effort=5",ylim=c(0,7))
 points(data$prod_age53,pch=16)
 abline(v=which(data$repro_ev53==1),lty=2) #each reproductive event
 abline(v=10,col="red") #age 10
#compare stored resources
data[,c(1,4,7,10,13,16,19)]
#compare produced resources
data[,c(2,5,8,11,14,17,20)]
#compare reproductive events
data[,c(3,6,9,12,15,18,21)]
```

#### Four life cycle stages: juvenile to adult to reproductive career to post-reproductive

```{r}
#four life cycle stages: juvenile to adult to reproductive career to post-reproductive

#define survival effort
surv_effort <- c(0.1,seq(0.25,1,0.25))
#define the proportion between survival and reproductive effort
proportion <- c(0.5,seq(1,10,1))
#combinations of survival effort and proportion
comb <- expand.grid(surv_effort,proportion)
#define reproductive effort
repro_effort <- apply(comb,1,prod)
#define the reproductive threshold
repro_thresh <- sapply(comb[,1],function(x) x*10)
#define the amount of resources you can produce
prod_stage <- c(1,2,2,1)

#check the life cycles with the combinations of survival and reproductive effort
for(b in 1:nrow(comb)){
 data <- data.frame(stored_res=c(0.5,rep(0,length.out=100)),prod_age=rep(0,length.out=101),repro_ev=rep(0,length.out=101),stage=rep(1,length.out=101))
 for(i in 1:nrow(data)){
   #first time step
   if(i == 1){
     data$prod_age[i] <- prod_stage[1]
     data$stored_res[i] <- data$stored_res[i]-comb[b,1]+data$prod_age[i]
   }else{
     #age at sexual maturity (transition to adult stage)
     if(data$stage[i-1]==1 & data$stored_res[i-1] >= repro_thresh[b]){
     data$repro_ev[i] <- 0
     data$prod_age[i] <- prod_stage[data$stage[i-1]]
     data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
     data$stage[i] <- 2
     } else{
        #age at first reproduction (transition to reproductive career)
        if(data$stage[i-1] == 2 & data$stored_res[i-1] >= repro_thresh[b]){
        data$repro_ev[i] <- 1
        data$prod_age[i] <- prod_stage[data$stage[i-1]]
        data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
        data$stage[i] <- 3
        } else{
           #reproductive function...increase of reproductive threshold by adding the reproductive effort multiplied by the number of descendants
           if(data$stage[i-1] == 3 & data$stored_res[i-1] >= repro_thresh[b]+(repro_effort[b]*sum(data$repro_ev[1:i]))){
           data$repro_ev[i] <- 1
           data$prod_age[i] <- prod_stage[data$stage[i-1]]
           data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
           data$stage[i] <- 3
           } else{
                data$prod_age[i] <- prod_stage[data$stage[i-1]]
                data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
                data$stage[i] <- data$stage[i-1]
              }
             } 
     }
    }
   }
 plot(data$stored_res~c(1:101),xlab=b)
 points(data$prod_age,pch=16)
 abline(v=which(data$repro_ev==1))
 abline(v=10,col="red",lty=2)
}

#no transition to post-reproductive

#let's try by increasing  reproductive effort while having more descendants

#define survival effort
surv_effort <- c(0.1,seq(0.25,1,0.25))
#define the proportion between survival and reproductive effort
proportion <- c(0.5,seq(1,10,1))
#combinations of survival effort and proportion
comb <- expand.grid(surv_effort,proportion)
#define reproductive effort
repro_effort <- apply(comb,1,prod)
#define the reproductive threshold
repro_thresh <- sapply(comb[,1],function(x) x*10)
#define the amount of resources you can produce
prod_stage <- c(1,2,2,1)

#check the life cycles with the combinations of survival and reproductive effort
for(b in 1:nrow(comb)){
 data <- data.frame(stored_res=c(0.5,rep(0,length.out=100)),prod_age=rep(0,length.out=101),repro_ev=rep(0,length.out=101),stage=rep(1,length.out=101),alb=rep(0,length.out=101))
 for(i in 1:nrow(data)){
   #first time step
   if(i == 1){
     data$prod_age[i] <- prod_stage[1]
     data$stored_res[i] <- data$stored_res[i]-comb[b,1]+data$prod_age[i]
   }else{
     #age at sexual maturity (transition to adult stage)
     if(data$stage[i-1]==1 & data$stored_res[i-1] >= repro_thresh[b]){
     data$repro_ev[i] <- 0
     data$prod_age[i] <- prod_stage[data$stage[i-1]]
     data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
     data$stage[i] <- 2
     } else{
        #age at first reproduction (transition to reproductive career)
        if(data$stage[i-1] == 2 & data$stored_res[i-1] >= repro_thresh[b]){
        data$repro_ev[i] <- 1
        data$alb[i] <- 0
        data$prod_age[i] <- prod_stage[data$stage[i-1]]
        data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
        data$stage[i] <- 3
        } else{
           #reproductive function...increase of reproductive threshold by adding the reproductive effort multiplied by the number of descendants
           if(data$stage[i-1] == 3 & data$stored_res[i-1] >= repro_thresh[b]+(repro_effort[b]*sum(data$repro_ev[1:i]))){
           data$repro_ev[i] <- 1
           data$alb[i] <- 0
           data$prod_age[i] <- prod_stage[data$stage[i-1]]
           data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
           data$stage[i] <- 3
           } else{
             #age at menopause (transition to post-reproductive career)
            if(data$stage[i-1] == 3 & data$stored_res[i-1] <= repro_thresh[b]+(repro_effort[b]*sum(data$repro_ev[1:b])) & data$alb[i-1] >= 10){
            data$prod_age[i] <- prod_stage[data$stage[i-1]]
            data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
            data$stage[i] <- 4
            } else{
                data$prod_age[i] <- prod_stage[data$stage[i-1]]
                data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
                data$stage[i] <- data$stage[i-1]
                data$alb[i] <- data$alb[i-1]+1
               }  
              }
             } 
     }
    }
   }
 plot(data$stored_res~c(1:101),xlab=b)
 points(data$prod_age,pch=16)
 abline(v=which(data$repro_ev==1))
 abline(v=10,col="red",lty=2)
}

#let's try by adding parental investment

#define survival effort
surv_effort <- c(0.1,seq(0.25,1,0.25))
#define the proportion between survival and reproductive effort
proportion <- c(0.5,seq(1,10,1))
#combinations of survival effort and proportion
comb <- expand.grid(surv_effort,proportion)
#define reproductive effort
repro_effort <- apply(comb,1,prod)
#define the reproductive threshold
repro_thresh <- sapply(comb[,1],function(x) x*10)
#define the amount of resources you can produce
prod_stage <- c(1,2,2,1)

#check the life cycles with the combinations of survival and reproductive effort
for(b in 1:nrow(comb)){
 data <- data.frame(stored_res=c(0.5,rep(0,length.out=100)),prod_age=rep(0,length.out=101),repro_ev=rep(0,length.out=101),stage=rep(1,length.out=101),alb=rep(0,length.out=101))
 for(i in 1:nrow(data)){
   #first time step
   if(i == 1){
     data$prod_age[i] <- prod_stage[1]
     data$stored_res[i] <- data$stored_res[i]-comb[b,1]+data$prod_age[i]
   }else{
     #age at sexual maturity (transition to adult stage)
     if(data$stage[i-1]==1 & data$stored_res[i-1] >= repro_thresh[b]){
     data$repro_ev[i] <- 0
     data$prod_age[i] <- prod_stage[data$stage[i-1]]
     data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
     data$stage[i] <- 2
     } else{
        #age at first reproduction (transition to reproductive career)
        if(data$stage[i-1] == 2 & data$stored_res[i-1] >= repro_thresh[b]){
        data$repro_ev[i] <- 1
        data$alb[i] <- 0
        data$prod_age[i] <- prod_stage[data$stage[i-1]]
        data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
        data$stage[i] <- 3
        } else{
           #reproductive function...increase of reproductive threshold by adding the reproductive effort multiplied by the number of descendants
           if(data$stage[i-1] == 3 & data$stored_res[i-1] >= repro_thresh[b]+(repro_effort[b]*sum(data$repro_ev[1:i]))){
           data$repro_ev[i] <- 1
           data$alb[i] <- 0
           data$prod_age[i] <- prod_stage[data$stage[i-1]]
           data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-repro_effort[b]
           data$stage[i] <- 3
           } else{
             #age at menopause (transition to post-reproductive career)
            if(data$stage[i-1] == 3 & data$stored_res[i-1] <= repro_thresh[b]+(repro_effort[b]*sum(data$repro_ev[1:b])) & data$alb[i-1] >= 10){
            data$prod_age[i] <- prod_stage[data$stage[i-1]]
            data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]
            data$stage[i] <- 4
            } else{
                data$prod_age[i] <- prod_stage[data$stage[i-1]]
                data$stored_res[i] <- data$stored_res[i-1]-comb[b,1]+data$prod_age[i]-(comb[b,1]*sum(data$repro_ev[1:b])) #adding parental investment
                data$stage[i] <- data$stage[i-1]
                data$alb[i] <- data$alb[i-1]+1
               }  
              }
             } 
     }
    }
   }
 plot(data$stored_res~c(1:101),xlab=b)
 points(data$prod_age,pch=16)
 abline(v=which(data$repro_ev==1))
 abline(v=10,col="red",lty=2)
}

```


### Maternal investment 

Maternal investment will follow a need-based dynamic, where mother will share resources with their descendants so they can have enough resources to cover the survival costs. The mother will share first resources to cover the need of the one with the largest gap between her resources available and survival cost, and follow the second one, and so on, until either the mother runs out of resource surplus or all the descendants have enough resources available to cover the survival costs.

```{r}
#Identify if the mother has surplus of resources
mom_surplus <- function(it_indpop){
  if(it_indpop$res_a[i] > surv_effort){
        it_indpop$mom_surplus[i] <- 1
    } else{
        it_indpop$mom_surplus[i] <- 0
    }
  return(it_indpop$mom_surplus)
}

#Identify the amount of surplus
it_indpop$mom_surplus_a[i] <- (it_indpop$res_a[i] - surv_effort)*it_indpop$mom_surplus[i]

#Identify if the descendants need resources
desc_need <- function(it_indpop){
  if(it_indpop$mom_id[i] %in% it_indpop$id & it_indpop$stage[i]==1 & it_indpop$res_a[i] < surv_effort){ #if your mother is alive, you are a juvenile, and don't have enough resources to cover the costs of survival
    it_indpop$desc_need[i] <- 1
  } else{
    it_indpop$desc_need[i] <- 0
  }
}

#Identify the amount of need for each descendant
it_indpop$desc_need_a[i] <- (surv_effort - it_indpop$res_a[i])*it_indpop$desc_need[i]

#Order the descendants by need and mother id
#subset of descendants
it_descpop <- it_indpop[it_indpop$desc_need == 1,]
#order the descendants by need and mother id
it_descpop[order(-it_descpop[,"desc_need"],it_descpop[,"mom_id"])]

#Mother invest in her descendants
mat_invest <- function(it_indpop){
  if(it_indpop$id[i] %in% it_descpop$mom_id & it_indpop$mom_surplus_a[i] > 0){#if the current individual is a mother of any descendants currently alive and if she has a surplus above zero
    it_descpop_momsub <- it_descpop[it_indpop$id[i] == it_descpop$mom_id, ] #subset the descendants of this mother
for(desc in 1:nrow(it_descpop_momsub)){.   # Loop through all of the mother's descendants, starting with the offspring with the largest need
    if(it_indpop$mom_surplus_a[i] > it_descpop_momsub$desc_need_a[desc]) { # If the mother does not have sufficient resources to cover the needs of the current descendant, she does not invest
    it_indpop$mom_surplus_a[i] <- it_indpop$mom_surplus_a[i] - it_descpop_momsub$desc_need_a[desc,] #discount the maternal investment for the mother
    it_descpop_momsub$res_a[desc]  <- it_descpop_momsub$res_a[desc] + it_descpop_momsub$desc_need_a[desc] #add the maternal investment for the descendant
    it_indpop$res_a[it_indpop$id == it_descpop_momsub$id[desc]] <- it_descpop_momsub$res_a[desc] #update the resources available of the descendant in the original database
    }
  }
  }
}

```